$(function(){var o=[];var g=1;var i="";var m=$(".container");var f=GetQueryString("roomId");var e=null;var n=null;var a=-105;var g=0;if(f==undefined||f=="null"){f=0}function l(p){$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/isOverComment.jspx?roomId="+f,dataType:"jsonp",jsonp:"callback",success:function(r){var q=r.code;if(q){p(r)}else{alert("活动未开启")}}})}l(function(r){var q=r.comment.startTime.time;var p=r.comment.endTime.time;if(j(q,p)){return}h(r);d()});function d(){$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/app/room/roomenter.jspx",dataType:"jsonp",jsonp:"callback",data:{roomId:f,sessionType:1,webType:2},success:function(q){var p=q.token;c(p)}})}function c(q){var p="ws://"+tomcatBase+"/ilive/webSocketServer.jspx?username="+q;ws=new WebSocket(p);ws.onopen=function(r){console.log("连接成功")};ws.onclose=function(r){console.log("关闭连接 ")};ws.onerror=function(r){console.log(r);console.log("建立连接异常"+r)};ws.onmessage=function(t){var r=JSON.parse(t.data);var s=r.liveMsgType;var v=r.deleteAll;if(v==1){$(".container").children().remove()}else{if(r.deleted==1){$("#msgId_"+r.msgId).remove()}else{if(s==2){if(r.checked==1){if($("#msgId_"+r.msgId).length==1){return false}var u=k(r.senderImage,r.senderName,r.webContent,r.msgId,i);o.push(u);b()}}}}};window.setInterval(function(){var s={p:"1"};if(ws){try{ws.send(JSON.stringify(s));console.log(s)}catch(r){console.log("websocket 连接已关闭")}}},10000)}function h(q){var p=q.comment.ewImg;var r=q.comment.imgUrl;$("#code").append('<img src="'+p+'">').parent().show();if(r!=""){$bg.css({"background-image":"url("+r+")"})}}function k(p,q,s,t,r){return html="<div "+r+' id="msgId_'+t+'"><dl><dt><img src="'+p+'"></dt><dd><p class="name">'+q+'</p><p class="body-area">'+s+"</p></dd></dl></div>"}function b(){var p=o.length;m.append(o[p-1]).find("div:last").hide().fadeIn(500);if(p>=7){clearInterval(e);e=setInterval(function(){if(o.length<=6){clearInterval(e);return}m.find("div").eq(6+g).hide().fadeIn(500);m.animate({marginTop:a*(g+1)},500,function(){m.find("div").eq(g).fadeIn(500);o.splice(0,1);g++})},1000)}}function j(q,p){var r=new Date().getTime();if(q>r||r>p){alert("活动未开始");return true}}});