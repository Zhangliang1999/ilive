var indexs=0;var id=0;var click=false;var disable;function inPrize(){var a=$("input[name=userId]").val();var b=$("input[name=roomId]").val();if(a==0){window.location.href="http://"+h5Base+"/pc/login.html?roomId="+b}disable=false;$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/getPrize.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",roomId:b,userId:a},success:function(g){console.log(g);if(g.code==401){window.location.href="http://"+h5Base+"/pc/login.html?roomId="+b;return false}else{if(g.code==1){var i=g.data;if(i==undefined||i==null||i==""){errorPrize("获取抽奖活动失败")}else{var h=g.prizeStatus;if(h==2){errorPrize("抱歉！来晚了！抽奖已经结束...")}else{if(h==1){var d=i.startTime;openPrize(d)}else{if(h==0){var f="";var c=i.lotteryType;var k=i.userNum;if(k==""||k==undefined){k=0}var l=["砸金蛋","摇一摇","九宫格抽奖"];f+='<div class="drawList">';f+='	<div class="nodrawText">'+l[c-1]+"</div>";f+='<div class="drawMain">';var j=i.list;var e=j.length;if(e<8){errorPrize("没有奖品")}else{switch(c){case 1:f+='	<div class="egg" id="egg">';f+='	    <div class="hammer" id="hammer"><img src="draw/images/chuizi.png" class="imgChuiZi"></div>';f+='		<div id="jindan" data-id="egg" onclick=\'drawBtn(this)\'></div>';f+="	</div>";break;case 2:f+='	<div class="red_bg">';f+='		<div class="red-ss-bg" data-id="shake" onclick=\'drawBtn(this)\'>';f+="			<div class=\"red-ss\" id='red-ss'></div>";f+="		</div>";f+="	</div>";break;case 3:indexs=0;f+='	<div class="draw" id="lottery">';f+="		<table>";f+="			<tr>";if(j[0].id!=0){f+='				<td id="prizeId_'+j[0].id+'" class="item lottery-unit lottery-unit-0" prizeId="0">';f+='					<div class="img">';f+='						<img src="'+j[0].prizeImg+'" >';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-0" prizeId="0">';indexs=indexs-1}f+='					<span class="name">'+j[0].prizeName+"</span>";f+="				</td>";f+='				<td class="gap"></td>';if(j[1].id!=0){f+='				<td id="prizeId_'+j[1].id+'" class="item lottery-unit lottery-unit-1" prizeId="1">';f+='					<div class="img">';f+='						<img src="'+j[1].prizeImg+'" >';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-1" prizeId="1">';indexs=indexs-1}f+='					<span class="name">'+j[1].prizeName+"</span>";f+="				</td>";f+='				<td class="gap"></td>';if(j[2].id!=0){f+='				<td id="prizeId_'+j[2].id+'" class="item lottery-unit lottery-unit-2"  prizeId="2">';f+='					<div class="img">';f+='						<img src="'+j[2].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-2"  prizeId="2">';indexs=indexs-1}f+='					<span class="name">'+j[2].prizeName+"</span>";f+="				</td>";f+="			</tr>";f+="			<tr>";f+='				<td class="gap-2" colspan="5"></td>';f+="			</tr>";f+="			<tr>";if(j[7].id!=0){f+='				<td id="prizeId_'+j[7].id+'" class="item lottery-unit lottery-unit-7" prizeId="7">';f+='					<div class="img">';f+='						<img src="'+j[7].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-7" prizeId="7">';indexs=indexs-1}f+='					<span class="name">'+j[7].prizeName+"</span>";f+="				</td>";f+='				<td class="gap"></td>';f+='				<td class="draw-btn" data-id="lottery" onclick=\'drawBtn(this)\'>GO</td>';f+='				<td class="gap"></td>';if(j[3].id!=0){f+='				<td id="prizeId_'+j[3].id+'" class="item lottery-unit lottery-unit-3"  prizeId="3">';f+='					<div class="img">';f+='						<img src="'+j[3].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-3"  prizeId="3">';indexs=indexs-1}f+='					<span class="name">'+j[3].prizeName+"</span>";f+="				</td>";f+="			</tr>";f+="			<tr>";f+='				<td class="gap-2" colspan="5"></td>';f+="			</tr>";f+="			<tr>";if(j[6].id!=0){f+='				<td id="prizeId_'+j[6].id+'" class="item lottery-unit lottery-unit-6"  prizeId="6">';f+='					<div class="img">';f+='						<img src="'+j[6].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-6"  prizeId="6">';indexs=indexs-1}f+='					<span class="name">'+j[6].prizeName+"</span>";f+="				</td>";f+='				<td class="gap"></td>';if(j[5].id!=0){f+='				<td id="prizeId_'+j[5].id+'" class="item lottery-unit lottery-unit-5"  prizeId="5">';f+='					<div class="img">';f+='						<img src="'+j[5].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-5"  prizeId="5">';indexs=indexs-1}f+='					<span class="name">'+j[5].prizeName+"</span>";f+="				</td>";f+='				<td class="gap"></td>';if(j[4].id!=0){f+='				<td id="prizeId_'+j[4].id+'" class="item lottery-unit lottery-unit-4"  prizeId="4">';f+='					<div class="img">';f+='						<img src="'+j[4].prizeImg+'" alt="">';f+="					</div>"}else{f+='				<td id="prizeId_'+indexs+'" class="item lottery-unit lottery-unit-4"  prizeId="4">';indexs=indexs-1}f+='					<span class="name">'+j[4].prizeName+"</span>";f+="				</td>";f+="			</tr>";f+="		</table>";f+="	</div>";setTimeout(function(){lottery.init("lottery")},0);break}}f+="</div>";f+='<div class="guize">剩余<span id="choujiangNumber">'+k+"</span>次机会 &nbsp;<a href='javascript:;' onclick=\"prizeList("+i.id+')" >查看奖品</a></div>';f+="</div>";$("#actionContent").html(f)}}}}}else{errorPrize(g.message)}}}})}function openPrize(a){var b='<div class="drawList">';b+='	<div class="drawnostartImg"><div class="endText">抽奖还未开始</div>';b+='	<div class="startText">将于 <span>'+a+"</span> 开启</div></div>";b+='<div class="modal-footer"><button type="button" class="btn tyBtn" data-dismiss="modal">确定</button></div>';b+="</div></div></div>";$("#actionContent").html(b)}function errorPrize(c,b){var a='<div class="drawList">';a+='	<div class="drawEndImg"><div class="endText">'+c+"</div></div>";a+='<div class="modal-footer">';if(b){a+='<button type="button" class="btn tyBtn" onclick="inPrize()">确定</button>'}else{a+='<button type="button" class="btn tyBtn" data-dismiss="modal">确定</button>'}a+="</div></div>";$("#actionContent").html(a)}function winningPrize(a){$(".drawMask").attr("drawMask","0");if(a==0){errorPrize("大奖擦肩而过...",true)}else{$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/getLotteryPrize.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",id:a},success:function(b){console.log(b);if(b.code==1){var c=b.data;var d='<div class="drawList">';d+='	<div class="nodrawText">恭喜您，中奖啦！<span>工作人员稍后会和您联系</span></div>';d+='	<div class="drawImg"><img src="'+c.prizeImg+'" alt=""/>';d+='	<div class="startText">'+c.prizeName+"</div></div>";d+='<div class="modal-footer">';d+='<button type="button" class="btn tyBtn" onclick="inPrize()">确定</button></div>';d+="</div>";$("#actionContent").html(d)}else{$.DialogBySHF.Alert({Width:350,Height:200,Title:"警告",Content:b.message})}}})}}function prizeList(a){$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/getPrizeList.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",lotteryId:a},success:function(d){console.log(d);if(d.code==1){var c=d.data;var e='<div class="drawList">';e+='		<div class="nodrawText">本期奖品</div>';e+='		<div class="drawMain">';e+='		<div class="drawListAll">';for(var b=0;b<c.length;b++){e+='		<div class="media">';e+='			<div class="media-left"><img class=\'media-object\' src="'+c[b].prizeImg+'" alt=""/></div>';e+='			<div class="media-body">';e+='				<div class="media-heading"><p>'+c[b].prizeName+"</p><p class='prizeNum'>x"+c[b].num+"</p></div>";e+="			</div>";e+="		</div>"}e+="</div>";e+='<div class="modal-footer"><button type="button" onclick="inPrize()" class="btn tyBtn">一键参与</button></div></div>';$("#actionContent").html(e);$(".drawListAll").slimScroll({height:"350px"}).css("padding-bottom","10px")}else{errorPrize(d.message)}}})}var lottery={index:-1,count:0,timer:0,speed:20,times:0,cycle:50,prize:-1,init:function(a){if($("#"+a).find(".lottery-unit").length>0){$lottery=$("#"+a);$units=$lottery.find(".lottery-unit");this.obj=$lottery;this.count=$units.length;$lottery.find(".lottery-unit.lottery-unit-"+this.index).addClass("drawactive")}},roll:function(){var a=this.index;var c=this.count;var b=this.obj;$(b).find(".lottery-unit.lottery-unit-"+a).removeClass("drawactive");a+=1;if(a>c-1){a=0}$(b).find(".lottery-unit.lottery-unit-"+a).addClass("drawactive");this.index=a;return false},stop:function(a){this.prize=a;return false}};function roll(){lottery.times+=1;lottery.roll();if(lottery.times>lottery.cycle+10&&lottery.prize==lottery.index){clearTimeout(lottery.timer);lottery.prize=-1;lottery.times=0}else{if(lottery.times<lottery.cycle){lottery.speed-=10}else{if(lottery.times==lottery.cycle){var a=Math.random()*(lottery.count)|0;var b=$("input[name=userId]").val();var c=$("input[name=roomId]").val();$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/userLottery.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",userId:b,roomId:c},success:function(d){console.log(d);if(d.code==1){id=d.data.prize;var e=$("#prizeId_"+id).attr("prizeId");lottery.prize=e}else{console.log(d.message);id=0}}})}else{if(lottery.times>lottery.cycle+10&&((lottery.prize==0&&lottery.index==7)||lottery.prize==lottery.index+1)){lottery.speed+=110;setTimeout(function(){winningPrize(id)},1000)}else{lottery.speed+=20}}}if(lottery.speed<40){lottery.speed=40}lottery.timer=setTimeout(roll,lottery.speed)}return false}function drawBtn(c){console.log($(c));var a=c.getAttribute("data-id");var b=$("#choujiangNumber").text();if(parseInt(b)>parseInt(0)){switch(a){case"lottery":StartLottery(c);break;case"egg":StartEgg(c);break;case"shake":StartShake(c)}}else{errorPrize("抽奖次数已使用完毕")}}function StartLottery(){if(disable){return}else{lottery.speed=100;roll();disable=true}}function StartEgg(a){$("#hammer").addClass("active");if(disable){alert("蛋都碎了，请勿再敲.");return}var b=$(a);setTimeout(function(){b.addClass("curr").parent();disable=true},750);setTimeout(function(){var c=$("input[name=userId]").val();var d=$("input[name=roomId]").val();$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/userLottery.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",userId:c,roomId:d},success:function(e){console.log(e);if(e.code==1){var f=e.data.prize;winningPrize(f)}else{console.log(e.message);errorPrize(e.message)}}})},1500)}function StartShake(a){if(disable){return}$("#red-ss").addClass("active");disable=true;setTimeout(function(){var b=$("input[name=userId]").val();var c=$("input[name=roomId]").val();$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/prize/userLottery.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",userId:b,roomId:c},success:function(d){console.log(d);if(d.code==1){var e=d.data.prize;winningPrize(e)}else{console.log(d.message);errorPrize(d.message)}}})},1500)};