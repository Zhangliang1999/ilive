var url=window.location.search.substr(1),searchParams=new URLSearchParams(url),Params={},myPlayer=videojs("video");Params.roomId=searchParams.has("roomId")?searchParams.get("roomId"):"0";Params.fileId=searchParams.has("fileId")?searchParams.get("fileId"):"0";Params.userId=searchParams.has("userId")?searchParams.get("userId"):"0";$("input[name=roomId]").val(Params.roomId);$("input[name=userId]").val(Params.userId);$("input[name=fileId]").val(Params.fileId);let _height=$(window).height()-$(".menuBox").offset().topif(!/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)){window.location.href="http://"+h5Base+"/pc/review.html?fileId="+Params.fileId+"&roomId="+Params.roomId}if(Params.fileId==""){errorfunction()}else{if(isWeiXin()){createAPI("http://"+tomcatBase+"/ilive/app/wx/app.jspx",{fileId:Params.fileId,roomId:Params.roomId}).then(function(a){let status=a.loginWx;if(status==1){window.stop();window.location.href=a.loginUrl;return false}}).then(function(){init()})}else{init()}}function init(){checklogin(function(){guide(function(a){let viewAuthorized=a.viewAuthorized;switch(viewAuthorized){case 2:window.location.href="http://"+h5Base+"/phone/password.html?roomId="+Params.roomId+"&fileId="+Params.fileId;break;case 3:console.log(3);break;case 6:window.location.href="http://"+h5Base+"/phone/FCode.html?roomId="+Params.roomId+"&fileId="+Params.fileId;break;default:Promise.all([createAPI("http://"+tomcatBase+"/ilive/app/room/vod/fileinfo.jspx",{fileId:Params.fileId}),createAPI("http://"+tomcatBase+"/ilive/file/enterprise.jspx",{userId:Params.userId,fileId:Params.fileId}),createAPI("http://"+tomcatBase+"/ilive/app/room/getrelatedlist.jspx",{fileId:Params.fileId}),createAPI("http://"+tomcatBase+"/ilive/app/wx/sharefileinfo.jspx",{fileId:Params.fileId})]).then(function(b){let [getMediaFile,getEnterprise,getFileList,shareinfo]=b;if(getMediaFile.code==1){setInit(getMediaFile,shareinfo);setEnterprise(getEnterprise);setFileList(getFileList);$("#loding").css("display","none");$(".page").css("visibility","visible")}else{layer.open({content:getMediaFile.message,btn:"确定",yes:function(){errorfunction()}})}},function(){layerOpen("获取数据失败")});break}})})}function checklogin(a){$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/app/room/vod/checklogin.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",fileId:Params.fileId,roomId:Params.roomId},success:function(b){if(b.code==1){let roomNeedLogin=JSON.parse(b.data).roomNeedLogin;if(roomNeedLogin===1){window.location.href="http://"+h5Base+"/phone/login.html?roomId="+Params.roomId+"&fileId="+Params.fileId+"&userId="+Params.userId}else{let userInfo=JSON.parse(b.data).userInfo;if(userInfo!=undefined||userInfo!=null){Params.userId=userInfo.userId;$("input[name=userId]").val(userInfo.userId)}a()}}else{window.location.href="404.html"}}})}function guide(a){$.ajax({type:"GET",url:"http://"+tomcatBase+"/ilive/app/room/vod/guide.jspx",dataType:"jsonp",jsonp:"callback",cache:false,data:{terminalType:"h5",fileId:Params.fileId,roomId:Params.roomId},success:function(b){switch(b.code){case 1:let liveEvent=b.data.liveEvent;a(liveEvent);break;case 402:window.location.href="http://"+h5Base+"/phone/login.html?roomId="+Params.roomId+"&fileId="+Params.fileId+"&userId="+Params.userId;break;case 404:window.location.href="http://"+h5Base+"/phone/end.html";break;default:layer.open({content:"引导鉴权失败",btn:"确定",yes:function(c){errorfunction()}});break}}})}function setInit(a,b){if(a.data!=null&&a.data!=undefined){let mediaFile={mediaFileName:a.data.mediaFileName,mediaFileDesc:a.data.mediaFileDesc,filePath:a.data.filePath,viewNum:a.data.viewNum,fileCover:a.data.fileCover,allowComment:a.data.allowComment,isFileDoc:a.data.isFileDoc}console.log(b);_shareTitle=b.data.friendCircle.mediaFileName;_shareImg=b.data.friendCircle.shareImg;_shareDesc=b.data.friendCircle.mediaFileDesc;_shareTitle2=b.data.friendSingle.mediaFileName;_shareImg2=b.data.friendSingle.shareImg;_shareDesc2=b.data.friendSingle.mediaFileDesc;options={shareUrl:window.location.href,cover:_shareImg,title:_shareTitle,content:_shareDesc,cover2:_shareImg2,title2:_shareTitle2,content2:_shareDesc2};sessionStorage.setItem("review",JSON.stringify(options));document.title=mediaFile.mediaFileName;$(".liveTitle").html(mediaFile.mediaFileName);$(".viewNum").text(setNum(mediaFile.viewNum));setVideo(mediaFile.filePath);if(mediaFile.isFileDoc==1){showFileDoc();$("#wendang").css("display","block")}if(mediaFile.allowComment==0){$(".chatipt").find("span").text("目前还不能讨论哦~");$("#talkLi").css("display","none");$(".menuBox").find("li").last().css("display","none")}else{showcomments()}window.chatipt.onclick=function(){if(mediaFile.allowComment==0){return}checkUserID();layer.open({type:1,className:"CB",content:talkCon(),anim:"up"});setTimeout(function(){A_Emoji($(".box"))},0);$(".textarea").on("input propertychange",function(){if($(".textarea").val().length!=0){$(".sendMessage").removeAttr("disabled");$(".sendMessage").css("background","#0084ff")}else{$(".sendMessage").css("background","#b2daff")}})};window.showDesc.onclick=function(){popup({title:"简介",content:desc(mediaFile.mediaFileDesc)})}}}function setEnterprise(a){if(a.code==1){var e={enterpriseId:a.data.enterpriseId,enterpriseImg:a.data.enterpriseImg,enterpriseName:a.data.enterpriseName,enterpriseDesc:a.data.enterpriseDesc,concernTotal:a.data.concernTotal,certStatus:a.data.certStatus,concernStatus:a.data.concernStatus,isReg:a.isReg};var d=0;if(e.enterpriseId==1969){d=15000}var c=d+e.concernTotal;concernTotalTemp=setNum(c);if(e.certStatus==4){var b={type:1,className:"guanzhu icon-jia"};if(e.concernStatus!=0){b={type:0,className:"yiguanzhu"}}$("#concernStatus").css("display","block").addClass(b.className).attr("onclick","updateConcernStatus("+e.enterpriseId+","+b.type+",event)")}if(e.isReg==1){$(".dianzan").find("i").addClass("checked")}createAPI("http://apizbt.tv189.net/ilive/register/MediaRegisterCount.jspx",{fileId:Params.fileId}).then(function(f){if(f.code==0){layer.open(f.message);return false}$("#dianzan-tag").text(f.data.count)});$("#companyName").text(e.enterpriseName);$("#concernTotal").find("span").text(concernTotalTemp);getEnterprise(e.enterpriseId)}else{$("#zbjcompany").hide()}}function setFileList(a){if(a.code===1&&a.data.length>0){let dom=createReviewFile(a.data)$("#reviewsAll").css("display","block").find(".swiper-wrapper").html(dom);new Swiper("#reviews",{slidesPerView:2.5,spaceBetween:5});window.showAllReview.onclick=function(){popup({title:"相关视频",content:show_all_review(a.data)})}}}function changeVideo(a){window.location.href="http://"+h5Base+"/phone/reviewNew.html?roomId="+Params.roomId+"&fileId="+a}function createReviewFile(b){var a=[];b.forEach(function(c){var d='<div class="swiper-slide">\n  <div class="review-group" onclick="changeVideo('+c.fileId+')">\n    <div class="review-img">\n      <img src="'+c.fileImg+'" alt="">\n      <div class="reviewMask"><span>'+c.fileDuration+'</span></div>\n    </div>\n    <div class="review-title">'+c.fileName+"</div>\n  </div>\n</div>\n";a.push(d)});return a.join("")}function show_all_review(d){var b=[];var c=[];var a=["公开观看","密码观看","付费观看","白名单观看","登录观看"];d.forEach(function(e){var f='<div class="reviewList" id="fileId_'+e.fileId+'" onclick="changeVideo('+e.fileId+')" >';f+='   <div class="reviewLeft">';f+='       <img src="'+e.fileImg+'" alt="" />';f+='       <div class="reviewMask">';f+="           <span>"+e.fileDuration+"</span>";f+="       </div>";f+="   </div>";f+='   <div class="reviewRight">';f+='       <div class="reviewRightTop">'+e.fileName+"</div>";f+='       <div class="reviewRightBottom">'+e.createTime+"</div>";f+='       <div class="reviewIcon">';f+='           <div class="reviewIcondiv"><i class="reviewplayIcon iconfont icon-video reviewplay"><span>'+e.viewNum+"次</span></i></div>";switch(e.authType){case 1:c="icon-yan";break;case 3:c="icon-qian";break;default:c="icon-mima";break}f+='           <div class="reviewIcondiv"><i class="reviewplayIcon iconfont '+c+' gongkai"><span>'+a[e.authType-1]+"</span></i></div>";f+="       </div>";f+="   </div>";f+="</div>";b.push(f)});return'<div id="review">'+b.join("")+"</div>"}function setVideo(a){myPlayer.ready(function(){this.src({src:a})})}function setNum(a){if(a>9999){a=(a/10000).toFixed(1)/1+"w"}return a}let fileDoc=null;let popupDisable=falselet docArr=[];function showFileDoc(){createAPI("http://"+tomcatBase+"/ilive/document/getByfileId.jspx",{fileId:Params.fileId}).then(function(a){if(a.code==1){$("#fileDoc").css("display","block");createFileDoc(a.data)}})}function createFileDoc(a){let arr=[];a.forEach(function(b){let str='<dl class="document document_'+b.document.id+'" data-docid="'+b.document.id+'">\n     <dd>\n      <img src="css/review/images/icon-p.png" class="ppt" alt="">\n      <div class="document-name ellipsis" onclick="fileDocDetail('+b.document.id+')">'+b.document.name+'</div>\n      <div class="links"><i class="iconfont icon-youjiantou"></i></div>\n      <div class="fileImgs"></div>\n     </dd>\n</dl>\n';arr.push(str)});fileDoc='<div class="document" style="height: 100vh">'+arr.join("")+"</div>";$("#document").html(arr.join(""))}function fileDocDetail(a){if(!popupDisable){popup({title:"文档预览",content:fileDoc});popupDisable=true}let curDoc=$(".showPopupContent").find(".document_"+a)if(curDoc.hasClass("open")){curDoc.removeClass("open");return}else{curDoc.addClass("open").siblings().removeClass("open")}let mescroll2=new MeScroll("mescroll2",{down:{use:false},up:{use:false}});mescroll2.scrollTo(curDoc[0].offsetTop-50);if(docArr[a]==undefined){createAPI("http://"+tomcatBase+"/ilive/document/getPicByDocId.jspx",{docId:a}).then(function(b){if(b.code==1){docArr[a]=b.data;wendangJS(curDoc,b.data)}})}else{wendangJS(curDoc,docArr[a])}}function wendangJS(b,a){let str='<div class="swiper-container " id="gallery_'+a[0].docId+'">\n'str+='<div class="swiper-wrapper">\n';for(let i=0;i<a.length;i++){let url=a[i].url;str+='<div class="swiper-slide"><img src="'+url+'"></div>\n'}str+="</div>\n";str+="</div>\n";str+='<div class="swiper-container thumbs" id="thumbs_'+a[0].docId+'">\n';str+=' <div class="swiper-wrapper">\n';for(let i=0;i<a.length;i++){let url=a[i].url;str+='<div class="swiper-slide"><img src="'+url+'"><span>'+(i+1)+"</span></div>\n"}str+="</div>\n";b.find(".fileImgs").html(str);let thumbsSwiper=new Swiper("#thumbs_"+a[0].docId,{spaceBetween:10,slidesPerView:3,watchSlidesVisibility:true,watchSlidesProgress:true,freeMode:true,freeModeMomentumRatio:5})new Swiper("#gallery_"+a[0].docId,{thumbs:{swiper:thumbsSwiper},lazy:{loadPrevNext:true,loadPrevNextAmount:2}})}let mescrolllet page={num:1,size:10,fileId:Params.fileId};function showcomments(){mescroll=new MeScroll("mescroll",{down:{use:false},up:{auto:true,isBounce:false,offset:150,noMoreSize:8,empty:{warpId:no_comment,icon:"css/review/images/nocomment.png",tip:"还没有讨论，快来聊几句吧~~"},htmlNodata:'<p class="upwarp-nodata">-- 我是有底线的 --</p>',callback:upCallback}});setTimeout(function(){$(".menuBox").find("li").on("click",function(){if($(this).hasClass("liactive")){return}if(this.className=="talkLi"){let talkli=document.querySelectorAll(".talkLi")[1]let offset=talkli.offsetTop+1$(talkli).css("min-height",_height);mescroll.scrollTo(offset);return}mescroll.scrollTo(0)});$(".mescroll").scroll(function(){nScrollTop=$(this)[0].scrollTop;let talkli=document.querySelectorAll(".talkLi")[1]let offset=talkli.offsetTop$(".menuBox").find("li.zbjj").addClass("liactive").siblings().removeClass("liactive");if(nScrollTop>offset){$(".menuBox").find("li.talkLi").addClass("liactive").siblings().removeClass("liactive")}})},0)}function upCallback(){getListDataFromNet(page.num,page.size,page.fileId,function(a){mescroll.endSuccess(a.length);setListData(a)},function(){mescroll.endErr()})}function getListDataFromNet(e,c,b,a,d){setTimeout(function(){try{createAPI("http://"+tomcatBase+"/ilive/app/room/vod/getcomments.jspx",{fileId:b,pageNo:e,pageSize:c}).then(function(g){page.num++;a&&a(g.data)})}catch(f){d&&d()}},1000)}function setListData(a){let dom=[]let str=""a.forEach(function(b){str=commentDom(b);dom.push(str)});$("#comment").append(dom.join(""))}function commentDom(a){let cusotm={className:"",css:""}if(a.topFlagNum==1){cusotm.className=" topBox";cusotm.css=' style="display: inline-block"'}return str='<div class="talkline'+cusotm.className+'" id="'+a.commentsId+'">\n          <div class="userImg"><img src="'+a.userImg+'"></div>\n          <div class="commentText">\n               <div class="inlineName">\n                   <span class="senderName">'+a.commentsUser+'<i class="questionIcon stickIcon" '+cusotm.css+'></i></span>\n                   <span class="createTime">'+a.createTime+'</span>\n               </div>\n             <div class="comment">'+a.comments+"</div>\n           </div>      </div>"}function saveComments(){let msgContent=$.trim($("input[name=msgContent]").val());if(msgContent.replace("/^s+|s+$/g+","")==""||msgContent==undefined){layerOpen("请输入消息内容");return false}else{createAPI("http://"+tomcatBase+"/ilive/app/room/vod/pushcomments.jspx",{userId:Params.userId,fileId:Params.fileId,comments:encodeURI(msgContent)}).then(function(b){if(b.code==-1||b.code==0){layerOpen(b.message)}else{if(b.code==1){let str=commentDom(b.data)if($(".mescroll-empty").length>0){$(".mescroll-empty").hide()}var a=$("#comment").find(".topBox").length;if(a>0){$("#comment").find(".topBox").eq(a-1).after(str)}else{$("#comment").prepend(str)}$("textarea[name=msgContent]").val("");layer.closeAll()}else{layerConfim(b.message,function(){window.location.href="http://"+h5Base+"/phone/login.html?roomId="+Params.roomId+"&fileId="+Params.fileId+"&userId="+Params.userId})}}})}}function saveMediaFile(){createAPI("http://"+tomcatBase+"/ilive/register/registerMedia.jspx",{fileId:Params.fileId,userId:Params.userId}).then(function(a){$(".dianzan").find("i").addClass("checked");let dianzanTag=$("#dianzan-tag")let tagNum=dianzanTag.text()dianzanTag.text(++tagNum)})}function popup(b){$(".videoBox").css("z-index","99999999");var a=layer.open({type:1,className:"CB",content:showPopupContent(b),anim:"up",shadeClose:false,style:" height:"+_height+"px; "});$(".showPopupContent .close").on("click",function(){layer.close(a);$(".videoBox").css("z-index","0");popupDisable=false})}function showPopupContent(a){return'<div class="showPopupContent">  <div class="header"><span class="ellipsis">'+a.title+'</span><i class="close iconfont icon-close"></i></div>  <div class="body mescroll" id="mescroll2">'+a.content+"</div></div>"}function desc(a){let title=$(".liveTitle").html();let view=$(".play-num").html()return'<div class="desc-content">\n       <div class="title liveTitle">'+title+'</div>\n       <div class="play-num">'+view+'</div>\n  <div class="content">'+a+"</div>\n";"   </div>\n"}function talkCon(){return'<div id="talkCon">\n    <div class="talkCon box">\n        <input type="text"  class="textarea"  placeholder="聊几句吧" id="saytext" onblur="wchatHackInput()" name="msgContent">\n        <div class="talkBottom">\n            <div class="hiddenDiv" style="display: none;"></div>\n            <div class="newhiddenDiv" style="display: none;"></div>\n            <div class="biaoqing emotion" data="emoji"></div>\n            <button class="sendMessage" disabled onclick="saveComments()">发送</button>\n            <div class="emojiBox" style="display: none;">\n                <section class="emoji_container"></section>\n            </div>\n        </div>\n    </div>\n</div>'}function checkUserID(){if(Params.userId==0){window.location.href="http://"+h5Base+"/phone/login.html?roomId="+Params.roomId+"&fileId="+Params.fileId+"&userId="+Params.userId;return false}}window.fenxiang.onclick=function(a){$("#customshade").css("display","block")};window.customshade.onclick=function(){$(this).css("display","none")};window.dianzan.onclick=function(){if($(this).find("i").hasClass("checked")){return}saveMediaFile()};window.wendang.onclick=function(){let docId=$(".document").eq(0).data("docid")fileDocDetail(docId)};