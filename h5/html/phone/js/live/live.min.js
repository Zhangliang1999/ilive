function WatchVideo(e){setVideoInfo(e),setAdvertising(),setWebSocket(e.token)}function setVideoInfo(e){myPlayer=videojs("video",{textTrackDisplay:!1,errorDisplay:!1})||null;var t=$('<button id="x5-fullscreen" class="vjs-fullscreen-control vjs-control vjs-button" type="button" style="display:none"><span aria-hidden="true" class="vjs-icon-placeholder"></span><span class="vjs-control-text" aria-live="polite">Fullscreen</span></button>'),n=document.getElementsByClassName("vjs-control-bar")[0];insertBeforeNode=document.getElementsByClassName("vjs-fullscreen-control")[0],n.insertBefore(t[0],insertBeforeNode);var i=e.data.liveEvent,s=10256==Params.roomId?"http://txcdn.pull.zb.tv189.com/live/zb.m3u8":e.hlsAddr;switch($("#playBg").css("background-image","url("+i.converAddr+")"),$("#iLiveRollingAdvertising").css("bottom","0"),$(".vjs-big-play-button").addClass("hide"),i.liveStatus){case 0:videoAppointment(i);break;case 1:videoOnLive(i,s),console.log("直播");break;case 2:videoPause(i),console.log("暂停");break;case 3:videoClose(i),console.log("关闭")}}function setAdvertising(){createAPI("http://"+tomcatBase+"/ilive/selectAdvertising.jspx",{roomId:Params.roomId}).then(function(e){if(1==e.code){var t=e.data.content,n=e.data.startType;if($("#iLiveRollingAdvertising").css("display","none"),1===n)return console.log("滚屏开启"),void $("#iLiveRollingAdvertising").css("display","block").text(t).marquee({duration:5e3})}else console.log("获取滚动消息失败："+data.message)})}function videoAppointment(e){var t=e.openCountdownSwitch,n=e.countdownTitle,i=e.liveStartTime;if($("#enterpriseList").css("padding-bottom","50px"),selectAppointment(),1===t)return $("#customContent").text(n),$(".videoPlay").css("display","block"),$("#timeStart").css("display","block"),$("#countdown").countdown(i).on("update.countdown",function(e){$(this).html(e.strftime('<span class="countspan digit">%d<span class="countDate count0"></span></span><span class="countDiv"></span><span class="countspan digit">%H<span class="countDate count1"></span></span><span class="countDiv"></span><span class="countspan digit">%M<span class="countDate count2"></span></span>'));var t=e.offset.days,n=e.offset.daysToWeek,i=e.offset.hours,s=e.offset.minutes;0==t&&0==n&&0==i&&s<=10&&$(".appointment").addClass("soon").text("即将开始")}).on("finish.countdown",function(){$("#timeStart").css("display","none"),$("#endLive").css("display","block").find(".textMask").text("本场直播尚未开始")}),!1;$("#endLive").css("display","block").find(".textMask").text("本场直播尚未开始")}function videoOnLive(e,t){$("#playBg").css("display","none"),$("#endLive").css("display","none"),$("#iLiveRollingAdvertising").css("bottom","16%"),$(".yuyueBox").css("display","none"),$("#videoPlay").css("display","none"),$(".vjs-has-started .vjs-poster").css("display","none"),myPlayer.ready(function(){$(".vjs-big-play-button").removeClass("hide"),this.src({src:t,type:"application/x-mpegURL"}),this.poster(e.playBgAddr),this.pause(),$(".vjs-live-control").text("实时直播"),this.on("play",function(){onceTime&&(ThemePlay.forEach(function(e){e.pause()}),onceTime=!1),judgeDeviceType.isAndroid&&dcVideo()}),this.on("error",function(){var e=this.error();console.log(e),1==e.code?console.log("视频播放被终止"):2==e.code?console.log("网络错误导致视频下载中途失败"):3==e.code?console.log("由于视频文件损坏或是该视频使用了你的浏览器不支持的功能，播放终止。"):4==e.code?console.log("视频因格式不支持或者服务器或网络的问题无法加载。"):5==e.code&&console.log("视频已加密，无法解密。")})})}function dcVideo(){var e=$("video")[0];window.screen.height,window.screen.width;e.addEventListener("x5videoenterfullscreen",function(){$(".vjs-fullscreen-control").hide(),$(".vjs-loading-spinner").hide(),setdcVideo(),$("#x5-fullscreen").on("click",function(){$("#x5-fullscreen").hide(),$("video").css({width:"",height:""})})}),e.addEventListener("x5videoexitfullscreen",function(){setdcVideo()}),e.addEventListener("ended",function(){})}function setdcVideo(){$("#x5-fullscreen").show();var e=window.screen.width,t=window.screen.height;setTimeout(function(){_height=$(window).height()-$(".menuBox").offset().top},350),$("video").css({width:e,height:t})}function videoPause(){$("#playBg").css("display","none"),$("#iLiveRollingAdvertising").css("bottom","0"),$("#endLive").css("display","block").find(".textMask").text("当前暂无直播画面"),$(".yuyueBox").css("display","none"),$(".vjs-has-started .vjs-poster").css("display","block")}function videoClose(){$(".yuyueBox").css("display","none"),$("#endLive").css("display","block").find(".textMask").text("本场直播已结束"),$("#iLiveRollingAdvertising").css("bottom","0")}function setWebSocket(e){if("undefined"!=typeof WebSocket){var t="ws://"+tomcatBase+"/ilive/webSocketServer.jspx?username="+e;ws=new WebSocket(t),ws.onopen=function(){heartCheck.start(),console.log("连接成功"+(new Date).toUTCString())},ws.onclose=function(){console.log("关闭连接 "+(new Date).toUTCString())},ws.onerror=function(){console.log("建立连接异常"+(new Date).toUTCString())},ws.onmessage=function(e){heartCheck.reset();var t=JSON.parse(e.data),n=t.roomType;switch(n){case 0:var i=t.iLiveEventVo.estoppleType;0==i?(gable_estoppelType=0,person_estoppelType=0,$("#chatipt").find("span").text("目前还不能讨论哦~")):(gable_estoppelType=1,person_estoppelType=1,$("#chatipt").find("span").text("聊几句吧~~"));var s=t.iLiveEventVo.liveStatus;switch(s){case 1:videoOnLive(t.iLiveEventVo,t.iLiveEventVo.hlsUrl);break;case 2:setTimeout(function(){videoPause(),myPlayer.ready(function(){this.pause(),$(".vjs-big-play-button").addClass("hide"),this.src({src:null,type:"application/x-mpegURL"})})},5e3);break;case 3:setTimeout(function(){videoClose(),$("#playBg").css("display","block"),myPlayer.ready(function(){$(".vjs-big-play-button").addClass("hide"),this.pause(),this.src({src:"none",type:"application/x-mpegURL"})})},23e3)}console.log("直播管理");break;case 1:if(1==t.deleteAll)return $("#commentBox").children().remove(),void $("#dixian").css("display","none");if(1==t.deleted)return $("#msgId_"+t.msgId).remove(),void($(".talkline").length>5?$("#dixian").css("display","block"):$("#dixian").css("display","none"));var o=t.senderId,a=t.opType;1==gable_estoppelType&&userId===o&&(11==a?(person_estoppelType=0,$("#chatipt").find("span").text("目前还不能讨论哦~")):(person_estoppelType=1,$("#chatipt").find("span").text("聊几句吧~~"))),$(".talkline").each(function(){var e=this.id,n="msgId_"+t.msgId;e==n&&$("#msgId_"+t.msgId).remove()});var r={commentsId:t.msgId,liveMsgType:t.liveMsgType,topFlagNum:t.top,userImg:t.senderImage,commentsUser:t.senderName,createTime:t.createTime,comments:t.webContent,replyName:t.replyName,replyContent:t.replyContent,replyType:t.replyType},l=_template.commentDom(r);if(1==t.checked){if(1==t.top)return void $("#commentTop").prepend(l);$("#comment").prepend(l)}else userId===o&&$("#comment").prepend(l);$(".talkline").length>5?$("#dixian").css("display","block"):$("#dixian").css("display","none"),console.log("消息管理");break;case 2:console.log("发现新话题"),$("#redDot").css("display","block"),$("#newTopic").css("display","block");break;case 3:window.location.href="http://"+h5Base+"/phone/end.html";break;case 4:console.log("广告滚动"),setAdvertising();break;case 5:console.log("抽奖"),isStartPrizr();break;case 6:console.log("投票"),isStartPrizr();break;case 7:console.log("赠送礼物");break;case 8:console.log("8");break;case 9:console.log("打赏");break;case 10:var c=t.welcomeLanguage;arr.push({code:2,welcomeLanguage:c}),giveGift(),console.log("欢迎语");break;case 11:var d={documentId:t.documentId,documentDownload:t.documentDownload,documentPageNO:t.documentPageNO,documentManual:t.documentManual};selectDocument(d),console.log("文档");break;case 15:console.log("签到活动"),isStartPrizr();break;case 16:console.log("红包"),isStartPrizr();break;default:console.log("操作类型"+t.roomType)}}}else layer.open({content:"你的浏览器不支持信息交流",btn:"确定",yes:function(){errorfunction()}})}function setDecorate(e){var t=e.data.liveEvent,n=t.pageDecorate;gable_estoppelType=t.estoppelType;var i={documentId:t.documentId,documentDownload:t.documentDownload,documentPageNO:t.documentPageNO,documentManual:t.documentManual},s=0;n.forEach(function(n,o){if(5!=n.menuType){var a=1==n.menuType?'<i class="redDot" id="redDot" style=" display:none;"></i>':"",r='<li class="'+(0==o?" liactive":"")+' swiper-slide" data-index="'+s+'" data-menuType='+n.menuType+" ><span>"+n.menuName+"</span>"+a+"</li>",l=$("#swiperContent");switch($("#swiperMenu .swiper-wrapper").append(r),s++,n.menuType){case 1:l.find(".swiper-wrapper").append('<div class="swiper-slide" id="theme">\n<div id="themes" class="mescroll"><div class="hintBox" id="newTopic" style="display: none">有一条新的内容，下拉刷新观看</div><div id="dataList" class="data-list"><div id="themesAllTop"></div><div id="themesAll"></div></div></div>'),0==o&&setThemes();break;case 2:l.find(".swiper-wrapper").append('<div class="swiper-slide" id="talkLi">\n<div class="commentBox mescroll"><div id="commentTop"></div><div id="comment"></div><div class="dixian" id="dixian" style="display: none"><span>-- 我是有底线的 --</span></div></div><div class="newtalkCon" id="sendMessageDIV" tablevalue="1">\n            <div class="talkConLeft ">\n                <img src="img/graywen.png" alt="">\n            </div>\n            <div class="talkConRight" id="chatipt">\n                   <span>聊几句吧~</span>\n            </div>\n            <!-- <div class="giftIcon hide" onclick="openGiftIcon()"></div> -->\n        </div></div>\n'),chatipt();break;case 3:break;case 4:l.find(".swiper-wrapper").append('<div class="swiper-slide ">\n<div class="commentBox mescroll" id="enterpriseList"><div class="cell showDesc" id="showDesc"></div>\n<div class="cell zbjcompany" id="zbjcompany"></div>\n<div class="cell reviewfsAll" id="reviewsAll" style="display: none"></div>\n<div class="cell ListConTit" id="ListConTit">\n  <div class="title ellipsis liveTitle">内容介绍</div>\n  <div id="livedescdiv"></div>\n</div>\n</div>\n<div class="yuyueBox" id="liveStart">\n     <button class="yuyue appointment" id="saveAppointment">预约开播通知</button>\n</div>\n</div>\n'),enterpriseList(e),saveAppointment();break;case 5:l.find(".swiper-wrapper").append('<div class="swiper-slide" id="review">5往期回看</div>');break;case 6:l.find(".swiper-wrapper").append('<div class="swiper-slide"><div class="wendang"></div></div>'),0!=t.documentId&&selectDocument(i)}}});var o=$("#swiperMenu").find("li");o.on("click",function(){var e=Number($(this).data("index"));pageSwiper.slideTo(e)}),pageSwiper=new Swiper("#swiperContent",{on:{slideChangeTransitionStart:function(){this.allowSlidePrev=!0,this.allowSlideNext=!0,o.removeClass("liactive").eq(this.activeIndex).addClass("liactive");var e=o.eq(this.activeIndex).data("menutype");1==e&&(Theme_mescroll?Theme_mescroll.resetUpScroll():setThemes()),this.isBeginning?this.allowSlidePrev=!1:this.isEnd&&(this.allowSlideNext=!1)}}})}function setThemes(){Theme_mescroll=new MeScroll("themes",{down:{use:!0,isBounce:!1,noMoreSize:4,clearEmptyId:"dataList",callback:selectMessageLIVE},up:{auto:!1,use:!1,clearEmptyId:"dataList"}});var e=new Swiper("#origin-img",{zoom:!0,zoomMax:5,zoomMin:2,width:window.innerWidth,virtual:!0,preloadImages:!1,pagination:{el:".swiper-pagination",type:"fraction"},on:{tap:function(){$("#origin-img").fadeOut(),this.virtual.slides.length=0,this.virtual.cache=[],!1}}});$(document).delegate(".thumb .toBig","click",function(){clickIndex=$(this).index();var t=$(this).parent().find("img");$(t).each(function(t,n){var i=$(n).attr("src");e.virtual.appendSlide('<div class="swiper-zoom-container"><img src="'+i+'" /></div>')}),e.slideTo(clickIndex),$("#origin-img").fadeIn(),!0})}function selectMessageLIVE(){getListDataFromNet(function(e){Theme_mescroll.endSuccess(e.length),setListData(e)},function(){Theme_mescroll.endErr()})}function getListDataFromNet(e,t){try{Promise.all([createAPI("http://"+tomcatBase+"/ilive/message/selectMessageLIVE.jspx",{roomId:Params.roomId}),createAPI("http://"+tomcatBase+"/ilive/comments/selectList.jspx",{roomId:Params.roomId,userId:userId})]).then(function(t){var[n,i]=t;if(commentsAllow=n.commentsAllow,senderImg=n.senderImg,1==n.code){var s=n.data,o=JSON.parse(i.iLiveCommentsMap),a=JSON.parse(i.praiseMap),r=restructureMSG(s,o,a,senderImg);e&&e(r)}})}catch(e){t&&t()}}function restructureMSG(e,t,n,i){var s=[],o=[];return t.forEach(function(e){o[e.msgId]=e}),e.forEach(function(e){e.comments=o[e.msgId]||[],e.praiseMap=n[e.msgId]||[],e.senderImg=i||"",s.push(e)}),s}function setListData(e){var t="";$("#themesAllTop").children().remove(),$("#themesAll").children().remove(),e.forEach(function(e){if(t=_template.theme(e),1==e.top?$("#themesAllTop").append(t):$("#themesAll").append(t),$("#msgId_"+e.msgId).find(".themeTime").attr("datetime",e.createTime),e.video){var n=$(".thumb").width(),i=videojs("video_"+e.msgId,{height:9*n/16,width:n},function(){var t=this;setTimeout(function(){t.src({src:e.video}),t.on("play",function(){ThemePlay.forEach(function(e){t.id_!=e.id_&&e.pause()}),myPlayer.pause(),onceTime=!0})},0)});ThemePlay.push(i)}}),timeago.render(document.querySelectorAll(".themeTime"),"zh_CN")}function selectCommentAll(e){$(e).css("display","none").prev().find(".pinlun").removeClass("hide")}function replyMore(e){var t=$(e).parents(".replyIcon").find(".replys-icon");t.hasClass("show")?t.toggleClass("show"):($(".replys-icon").removeClass("show"),t.toggleClass("show"))}function saveILiveMessagePraise(e,t,n){if(replyMore(e),!n)return 0===userId?(setlogin(),!1):void createAPI("http://"+tomcatBase+"/ilive/praise/savePraise.jspx",{userId:userId,msgId:t}).then(function(n){var i=n.code;if(401==i?setlogin():402==i&&setlogin("bindPhone"),1==i){var s='<span class="dzName">'+nailName+"</span>";$("#msgId_"+t).find(".themeFooter").removeClass("hide").find(".themeFooter-top").removeClass("hide").append(s),$(e).attr("onclick","saveILiveMessagePraise(this,"+t+", true)").find("span").text("已赞")}else layerOpen("点赞操作失败")})}function enterpriseList(e){e.data.isSign;var t={enterpriseId:e.data.enterprise.enterpriseId,enterpriseImg:e.data.enterprise.enterpriseImg,enterpriseName:e.data.enterprise.enterpriseName,enterpriseDesc:e.data.enterprise.enterpriseDesc,concernTotal:e.data.enterprise.concernTotal,certStatus:e.data.enterprise.certStatus,concernStatus:e.data.enterprise.concernStatus,isReg:e.isReg},n={liveTitle:e.data.liveEvent.liveTitle,liveStartTime:e.data.liveEvent.liveStartTime};_template.showDesc(n),selectRoomNumber(),_template.zbjcompany(t),getReviewList(),$("#livedescdiv").html(e.data.liveEvent.liveDesc)}function getReviewList(){createAPI("http://"+tomcatBase+"/ilive/app/room/getrecordlist.jspx",{roomId:Params.roomId}).then(function(e){if(1===e.code&&e.data.length>0){var t=e.relatedVideo;if(0==t)return;var n=_template.reviewsAll(e),i=_template.show_all_review(e.data);$("#reviewsAll").css("display","block").html(n),$(".review-List").html(i),new Swiper("#reviews",{slidesPerView:2.5,spaceBetween:5}),window.showAllReview.onclick=function(){popup({id:"review",title:e.hkmc,content:$("#review").html()}),mescroll_review=new MeScroll("mescroll_review",{down:{use:!1},up:{page:{size:15},auto:!0,isBounce:!1,noMoreSize:8,htmlNodata:'<p class="upwarp-nodata">-- 我是有底线的 --</p>',callback:reviewCallback}})}}})}function reviewCallback(e){getListReview(Num,e.size,function(e){mescroll_review.endSuccess(e.length);var t=_template.show_all_review(e);$(".review-List").append(t),$(".mescroll-hardware").prev().css("padding-bottom",0)},function(){review_mescroll.endErr()})}function getListReview(e,t,n,i){try{createAPI("http://"+tomcatBase+"/ilive/app/room/getrecordlist.jspx",{roomId:Params.roomId,pageNo:e,pageSize:t}).then(function(e){e.data.length>0&&Num++,n&&n(e.data)})}catch(e){i&&i()}}function selectRoomNumber(){createAPI("http://"+tomcatBase+"/ilive/online/number.jspx",{roomId:Params.roomId}).then(function(e){var t=e.code;if(1==t){var n=JSON.parse(e.data).number;null!=n&&null!=n||(n=0),$(".onlineNumberSpan").html(setNum(n)),setTimeout(function(){selectRoomNumber()},1e4)}})}function selectAppointment(){0!=userId&&createAPI("http://"+tomcatBase+"/ilive/homepage/isAppointment.jspx",{roomId:Params.roomId,userId:userId}).then(function(e){1==e.code?1==e.data.isAppointment?$(".appointment").addClass("select").text("取消预约开播"):$(".appointment").removeClass("select").text("预约开播通知"):layerOpen("预约信息查询失败!")})}function isStartPrizr(){createAPI("http://"+tomcatBase+"/ilive/prize/isStartPrizr.jspx",{roomId:Params.roomId}).then(function(e){var t=e.data.isStartRedPacket,n=e.data.isStartVote,i=e.data.isStartPrizr,s=e.data.isStartSign;s?$("#qiandao").css("display","block"):$("#qiandao").css("display","none"),i?$("#draw").css("display","block"):$("#draw").css("display","none"),n?$("#toupiao").css("display","block"):$("#toupiao").css("display","none"),t?$("#hongbao").css("display","block"):$("#hongbao").css("display","none")})}function checkRegister(e){createAPI("http://"+tomcatBase+"/ilive/register/queryIsRegister.jspx",{liveEventId:e,userId:userId}).then(function(e){if(1==e.code){var t=e.code;if(1!=t)return layerOpen("获取签到、点赞失败"),!1;var n=e.data.isQiandaoReg,i=e.data.isDianzanReg;1==n&&$("#qiandao").addClass("active"),1==i&&$("#dianzan").addClass("active").find("span").eq(0).text("已赞")}})}function roomCount(e){createAPI("http://"+tomcatBase+"/ilive/register/RoomRegisterCount.jspx",{roomId:Params.roomId,eventId:e}).then(function(e){1==e.code&&(dianzanNum=e.data.count,$("#dianzan_num").text(dianzanNum))}),setTimeout(function(){roomCount(e)},6e4)}function GetSignId(e){createAPI("http://"+tomcatBase+"/ilive/prize/isSign.jspx",{roomId:Params.roomId}).then(function(t){if(1!=t.code)return layerOpen(t.message),!1;signId=t.signId,e()})}function qiandaoHTML(){return html='<div class="main-popup "><div class="Input"><input type="tel" placeholder="手机号"   maxlength="11" name="phoneNum" onblur="validate(this)" id="phoneNum"/></div><div class="Input"><input type="tel" placeholder="动态密码"  maxlength="6"  name="vPassword_Q" onblur="wchatHackInput()"/><span class="yzmBtn1" onclick="getAuthenticode(this)" id="spenTimer">获取动态密码</span></div><div class="Input"><input type="text" placeholder="昵称 建议使用您的真实姓名签到，2-10个字"  minlength="2" maxlength="10" onblur="wchatHackInput()" name="username_Q"/></div><div class="text-center loginBox"><button type="button" class="confirmbutton QiandaoBtn disableBtn" disabled onclick="saveQiandao()">点击立即签到</button></div></div>',html}function validate(e){wchatHackInput();var t=e.value;if(null!=t&&""!=t){if(!isPoneAvailable(t.trim()))return layerOpen("请输入正确的手机号"),!1;createAPI("http://"+tomcatBase+"/ilive/prize/siginPhone.jspx?",{userPhone:t,signId:signId}).then(function(e){var t=e.status;if(1==t)return layerOpen("您已签到"),$(".QiandaoBtn").attr("disabled","true").addClass("disableBtn"),!1;$(".QiandaoBtn").removeAttr("disabled").removeClass("disableBtn")})}}function saveQiandao(){wchatHackInput();var e=$("input[name=phoneNum]").val(),t=$("input[name=vPassword_Q]").val(),n=$("input[name=username_Q]").val();return null==e||""==e.replace("s+","")?(layerOpen("请输入手机号!"),!1):null==t||""==t.replace("s+","")?(layerOpen("验证码不能为空!"),!1):null==n||""==n.replace("s+","")?(layerOpen("昵称不能为空!"),!1):void createAPI("http://"+tomcatBase+"/ilive/prize/userSign.jspx",{userphone:e,username:encodeURIComponent(n),vPassword:t,roomId:roomId,signId:signId}).then(function(e){return"0"==e.status?(layerOpen(e.msg),!1):1e3==e.status?(layerOpen(e.msg),setTimeout(function(){layer.closeAll()},2e3),!1):1001==e.status?(layerOpen(e.msg),!1):1002==e.status?(layerOpen(e.msg),!1):void 0})}function saveMediaFile(){createAPI("http://"+tomcatBase+"/ilive/register/registerRoom.jspx",{userId:userId,roomId:Params.roomId}).then(function(e){401==e.code?window.location.href="http://"+h5Base+"/phone/login.html?roomId="+roomId:402==e.code?saveMessagerPhoneNumber():403==e.code||(1==e.code?(dianzanNum++,$("#dianzan_num").text(dianzanNum),$("#dianzan").addClass("active").find("span").eq(0).text("已赞")):layerOpen(e.message))})}function hbdom(){return'<div class="hongbao ">\n<canvas width="510" height="661" id="popuphongbao" style="display: none"></canvas>\n<img src="" id="imghongbao" class="copyBtn" data-clipboard-action="copy" data-clipboard-target="#copyhongbao" onclick="">\n<input id="copyhongbao" type="text" value="">\n</div>\n<div class="close" id="popclose"></div>'}function openhongbao(e){if(!hbflag){var t=e.split(""),n=$("#popuphongbao")[0],i=n.getContext("2d"),s=$("#imghongbao")[0],o=new Image,a=[],r=[];$.each(t,function(e,t){e<=9?a.push(t):r.push(t)});var l=a.join("  "),c=r.join("  ");o.src="img/hongbaokl.png",o.onload=function(){i.drawImage(o,0,0),i.textBaseline="middle",i.textAlign="center";var t=n.width/2,a=n.height/2;i.fillStyle="#000",c.length>0?(i.font="24px Microsoft YaHei",i.fillText(l,t,a+45),i.fillText(c,t,a+80)):(i.font="28px Microsoft YaHei",i.fillText(l,t,a+65)),s.src=n.toDataURL("image/jpg"),$("#copyhongbao").val(e)};var d=new ClipboardJS(".copyBtn");d.on("success",function(e){console.info("Action:",e.action),console.info("Text:",e.text),console.info("Trigger:",e.trigger),layerOpen("复制成功"),e.clearSelection()}),d.on("error",function(e){layerOpen("复制失败，请长按复制")})}}function saveAppointment(){$("#saveAppointment").on("click",function(){if(0==userId)return setlogin(),!1;$(this).hasClass("soon")||createAPI("http://"+tomcatBase+"/ilive/homepage/saveAppointment.jspx",{roomId:Params.roomId,userId:userId}).then(function(e){if(401==e.code)return setlogin(),!1;if(402==e.code)return setlogin("bindPhone"),!1;if(403==e.code);else if(1==e.code)if(null!=e.data.userid){var t=e.status;1==t?(layerOpen('<div class="title">预约成功</div><div class="content">将在直播开始前10分钟，通过短信和天翼直播APP的消息通知您观看！</div>',3),$(".appointment").addClass("select").text("取消预约开播")):2==t&&($(".appointment").removeClass("select").text("预约开播通知"),layerOpen(e.message))}else $(".appointment").removeClass("select").text("预约开播通知"),layerOpen(e.message);else layerOpen("预约失败")})})}function chatipt(){person_estoppelType||$("#chatipt").find("span").text("目前还不能讨论哦~"),$("#chatipt").on("click",function(){person_estoppelType&&(chatiptOpen(),$(".wen").show())}),$(".talkConLeft").on("click",function(){person_estoppelType&&(chatiptOpen(),$(".wen").show())})}function commentsList(e,t){replyMore(e),$("input[name=commentsMsgId]").val(t),0!=commentsAllow?chatiptOpen("theme"):layerOpen("评论功能已关闭")}function selectDocument(e){var t=e.documentId,n=e.documentDownload,i=e.documentPageNO;e.documentManual;def_Manual=e.documentManual,-1==t?(checkslide(),gallerySwiper.slideTo(i-1,1e3,!1)):createAPI("http://"+tomcatBase+"/ilive/document/getByd.jspx",{docId:t}).then(function(e){if(1==e.code){if(null!=e.data){var t=e.data,s=t.list,o='<div class="Wtitle">'+t.name+"</div>\n";o+='<div class="swiper-container " id="gallery">\n',o+='  <div class="swiper-wrapper">\n',o+="  </div>\n",o+="</div>\n",o+='<div class="swiper-container " id="thumbs">\n',o+='  <div class="swiper-wrapper">\n';for(var a=0;a<s.length;a++){var r=s[a].url;o+='<div class="swiper-slide"><img src="'+r+'"></div>\n'}o+="  </div>",o+='<div class="swiper-scrollbar"></div>\n',o+="</div>\n",o+="</div>\n",$(".wendang").html(o),wendangJS(s,i-1),0==n?$(".pptBtn").addClass("hide"):$(".pptBtn").removeClass("hide")}}else layerOpen(e.message)})}function wendangJS(e,t){thumbsSwiper=new Swiper("#thumbs",{spaceBetween:10,slidesPerView:3.5,watchSlidesVisibility:!0,watchSlidesProgress:!0,noSwiping:!0,freeMode:!0,freeModeMomentumRatio:5}),gallerySwiper=new Swiper("#gallery",{spaceBetween:10,width:window.innerWidth,noSwiping:!0,observer:!0,observeParents:!0,virtual:{slides:function(){for(var t=[],n=0;n<e.length;n++){var i=e[n].url;t.push('<div class="swiper-slide"><img data-src="'+i+'"  class="swiper-lazy"><div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div></div>')}return t}()},lazy:{loadPrevNext:!0,loadPrevNextAmount:2},thumbs:{swiper:thumbsSwiper},scrollbar:{el:".swiper-scrollbar",draggable:!0}}),gallerySwiper.slideTo(t,1e3,!1),checkslide()}function checkslide(){swiperStatus=def_Manual,def_Manual?(gallerySwiper.$wrapperEl.removeClass("swiper-no-swiping"),thumbsSwiper.$wrapperEl.removeClass("swiper-no-swiping"),$(".swiper-scrollbar").removeClass("hide")):(gallerySwiper.$wrapperEl.addClass("swiper-no-swiping"),thumbsSwiper.$wrapperEl.addClass("swiper-no-swiping"),$(".swiper-scrollbar").addClass("hide"))}function setguides(){createAPI("http://"+tomcatBase+"/ilive/appuser/getGuideUrl.jspx",{roomId:Params.roomId}).then(function(e){var t=e.data.imgUrl||"img/defultBg.jpg";_template.guide(),$(".guide").css({display:"block",backgroundImage:"url("+t+")"});var n=5,i=setInterval(function(){$(".guide-num").text(n),1===n&&($(".guide").fadeOut(),clearInterval(i)),--n},1e3);$(".guide-box").on("click",function(){$(".guide").fadeOut(),clearInterval(i)})})}var ws,nailName,swiperStatus,pageSwiper,gable_estoppelType,liveEventId=0,dianzanNum=0,lastTouchEnd=0,u=navigator.userAgent,person_estoppelType=1;if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(u)||(window.location.href="http://"+h5Base+"/pc/play.html?roomId="+Params.roomId),0==Params.roomId)errorfunction();else{function init(){checklogin()}function checklogin(){createAPI("http://"+tomcatBase+"/ilive/app/room/checkRoomLogin.jspx",{roomId:Params.roomId}).then(function(e){try{var t=JSON.parse(e.data),n=t.userInfo;if(null!=n||null!=n){userId=n.userId,nailName=n.nailName,null==userId&&null==userId||$("input[name=userId]").val(userId);var i={userphone:n.mobile};window.sessionStorage.setItem("plinfo",JSON.stringify(i))}switch(e.code){case 0:layer.open({content:e.message,btn:"确定",yes:function(){errorfunction()}});break;case 1:window.sessionStorage.setItem("roomName",t.roomTitle||"天翼直播平台");var s=t.roomNeedLogin,o=t.openGuideSwitch;1===o&&setguides(),1===s?setlogin():2===s&&secondPermission();break;case 404:window.location.href="http://"+h5Base+"/phone/end.html";break;case 402:setlogin("bindPhone")}}catch(e){layerOpen(e.name+": "+e.message)}})}function secondPermission(){createAPI("http://"+tomcatBase+"/ilive/app/room/getRoomInfo.jspx",{roomId:Params.roomId}).then(function(e){try{switch(e.code){case 0:window.location.href="http://"+h5Base+"/phone/nopermission.html?roomId="+Params.roomId;break;case 3:window.location.href="http://"+h5Base+"/phone/standby.html?roomId="+Params.roomId;break;case 404:window.location.href="http://"+h5Base+"/phone/end.html";break;case 402:0!==userId?setlogin("bindPhone"):layer.open({content:"绑定手机号，获取用户失败",btn:"确定",yes:function(){errorfunction(getRoomInfo)}});break;case 1:var t=e.data.liveEvent,n=t.viewAuthorized,i=t.openSignupSwitch;if(1==i)return window.location.href="http://"+h5Base+"/phone/form.html?roomId="+Params.roomId,!1;switch(n){case 2:setlogin("password");break;case 3:case 6:setlogin("FCode");break;default:thirdPermission(e)}break;default:window.location.href="http://"+h5Base+"/phone/nopermission.html?roomId="+Params.roomId}}catch(e){layerOpen(e.name+": "+e.message)}})}function thirdPermission(e){createAPI("http://"+tomcatBase+"/ilive/app/room/roomenter.jspx",{roomId:Params.roomId,sessionType:1,webType:1}).then(function(t){try{var n=t.code;switch(n){case 1:$("#loding").hide();var i=t.data.liveEvent;$("input[name=liveEventId]").val(i.liveEventId),liveEventId=i.liveEventId;var s=i.liveTitle||"";document.title=s,_template.page(),_height=$(window).height()-$(".menuBox").offset().top,setDecorate(e),WatchVideo(t);var o=t.forbidTalk;o&&(person_estoppelType=0,$("#chatipt").find("span").text("目前还不能讨论哦~")),isStartPrizr(),checkRegister(i.liveEventId),roomCount(i.liveEventId),wxshare.init();break;case 2:var a=window.sessionStorage.getItem("permissionsjump");if(null==a||1==a)return window.sessionStorage.setItem("permissionsjump",1),setlogin(),!1;window.location.href="http://"+h5Base+"/phone/permissions.html?roomId="+roomId;break;case 3:window.location.href="http://"+h5Base+"/phone/standby.html?roomId="+roomId;break;default:layer.open({content:"第三次失败，请联系管理员",btn:"确定",yes:function(){errorfunction()}})}}catch(e){layerOpen(e.name+": "+e.message)}})}judgeDeviceType.isWeiXin?createAPI("http://"+tomcatBase+"/ilive/app/wx/app.jspx",{roomId:Params.roomId}).then(function(e){try{var t=e.loginWx;if(1==t)return window.stop(),window.location.href=e.loginUrl,!1;init()}catch(e){layerOpen(e.name+": "+e.message)}}):init()}var Theme_mescroll,commentsAllow,senderImg,mescroll_review,onceTime=!1,heartCheck={timeout:2e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this.start()},start:function(){var e=this;this.timeoutObj=setTimeout(function(){var t={p:"1"};ws.send(JSON.stringify(t)),console.log("websocket 发送"),e.serverTimeoutObj=setTimeout(function(){ws.close()},e.timeout)},this.timeout)}},ThemePlay=[],Num=2,signId=0;window.qiandao.onclick=function(){$("#btnIcons").click(),GetSignId(function(){popup({title:"签到",content:qiandaoHTML()})})};var gallerySwiper,thumbsSwiper,def_Manual,hbflag=!1;$("#hongbao").on("click",function(){$("#btnIcons").click(),createAPI("http://"+tomcatBase+"/ilive/prize/isRedPacket.jspx",{roomId:Params.roomId}).then(function(e){if(1==e.code){var t=layer.open({type:1,content:hbdom(),className:"popuo-concernMsg"});$("#popclose").on("click",function(){layer.close(t)}),openhongbao(e.packet.command),hbflag=!0}else layerOpen(e.message)})}),$("#toupiao").on("click",function(){if($("#btnIcons").click(),0==userId)return setlogin(),!1;popup({title:"投票",content:_template.tpdom()}),selectTouPiao()}),$("#draw").on("click",function(){if($("#btnIcons").click(),0==userId)return setlogin(),!1;popup({title:"抽奖",content:_template.drawdom()}),inPrize()}),$("#btnIcons").on("click",function(){$(this).toggleClass("active"),$(this).prev().toggleClass("active ")}),$(document.body).delegate(".talkConLeft","click",function(){$(".wen").attr("msgValue","3").css({background:"url(img/question.png) no-repeat","background-size":"100% 100%"}),setTimeout(function(){$(".textarea").focus()},0)}),window.onbeforeunload=function(){ws&&ws.onclose()},window.onunload=function(e){ws&&ws.onclose()};