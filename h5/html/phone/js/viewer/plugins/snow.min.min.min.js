var krpanoplugin=function(){function b(ad,y){y=!0===y;if(o&&j){var ak=p.get("view");if(null!=ak&&null!=ak.r_rmatrix){var W=j,ai=o.width,Z=o.height;W.clearRect(0,0,ai,Z);var ar,G=1;switch(String(c.mode).toLowerCase()){case"snow":G=1;break;case"image":G=3}var aj=c.flakes;p.ismobile&&1000<aj&&(aj=1000);p.istablet&&2000<aj&&(aj=2000);var X=c.color,r=1000*c.floor,x=1000*c.spreading,au=1*c.imagescale,ap=1*c.speed,w=1*c.shake,B=1*c.speedvariance,v=1*c.wind,ah=c.winddir*Math.PI/180;l!=X&&(i=null,l=X);if(null==i){i=document.createElement("canvas");i.width=2;i.height=2;var u=i.getContext("2d");u.fillStyle="rgba("+(X>>16&255)+","+(X>>8&255)+","+(X&255)+",0.5)";u.fillRect(0,0,2,2)}var X=i,u=v*Math.cos(ah),v=v*Math.sin(ah),ah=null,at=0,aq=0;if(3==G){var al=c.imageurl;if(null==al||""==al){return}q!=al&&(e=null,q=al,e=new Image,e.src=p.parsePath(q));if(null==e){return}e&&e.complete&&(ah=e,at=ah.naturalWidth,aq=ah.naturalHeight);if(null==ah){return}}null==n&&(n=Array(3*aj));if(0==y&&aj!=k){if(k<aj){for(ar=3*k;ar<3*aj;ar+=3){n[0|ar]=(Math.random()-0.5)*x,n[0|ar+2]=(Math.random()-0.5)*x,n[0|ar+1]=-(Math.random()*(r+1500))+r}}k=aj}var ai=0.5*ai,al=0.5*Z,af=Number(ak.r_zoff);isNaN(af)&&(af=0);ar=p.stagescale;Z=ak.r_zoom*Z/p.stageheight/ar;ar=Math.max(4*p.stageheight/3,p.stagewidth)/ar;au*=ar*Z/(2*al);ar=ak.r_rmatrix;var z,t,h,g,f,a,ag,ae;ar.hasOwnProperty("m11")?(ak=ar.m11,z=ar.m12,t=ar.m13,h=ar.m21,g=ar.m22,f=ar.m23,a=ar.m31,ag=ar.m32,ae=ar.m33):(ak=ar[0],z=ar[1],t=ar[2],h=ar[4],g=ar[5],f=ar[6],a=ar[8],ag=ar[9],ae=ar[10]);var M=1000/(m+1)/122;0.5<M&&(M=0.5);var M=M*ap,w=w*M,ao,an,am,s;for(ar=0;ar<3*aj;ar+=3){ap=n[0|ar],ao=n[0|ar+1],an=n[0|ar+2],0==y&&(ao+=M*(10+Math.random()*B),ao>r&&(ap=(Math.random()-0.5)*x,an=(Math.random()-0.5)*x,ao=1*(-1000-500*Math.random())),ap+=(Math.random()-0.5)*w+u,an+=(Math.random()-0.5)*w+v,2000<ap?ap-=4100:-2000>ap&&(ap+=4100),2000<ao?ao-=4100:-2000>ao&&(ao+=4100),n[0|ar]=ap,n[0|ar+1]=ao,n[0|ar+2]=an),am=ap,s=ao,ap=ak*am+h*s+a*an,ao=z*am+g*s+ag*an,an=t*am+f*s+ae*an+af,10<an&&(1==G?(an=Z/an,ap*=an,ao*=an,ap>-ai&&ap<+ai&&ao>-al&&ao<al&&(ap+=ai-1,ao+=al-1,W.drawImage(X,ap|0,ao|0))):3==G&&(am=an,an=Z/an,ap*=an,ao*=an,am=au/am,an=0.5*at*am,am*=0.5*aq,ap>-ai-an&&ap<+ai+an&&ao>-al-am&&ao<al+am&&(ap+=ai-an,ao+=al-am,W.drawImage(ah,0,0,at,aq,ap,ao,an,am))))}}}}var p=null,c=null,o=null,j=null,l=null,n=null,k=0,q=null,e=null,m=30,d=null,i=null;this.registerplugin=function(f,g,a){p=f;c=a;c.registerattribute("mode","snow");c.registerattribute("imageurl","");c.registerattribute("flakes",p.ismobile||p.istablet?1000:4000);c.registerattribute("color",16777215);c.registerattribute("floor",0.3);c.registerattribute("speed",1);c.registerattribute("spreading",4);c.registerattribute("shake",4);c.registerattribute("speedvariance",2);c.registerattribute("wind",0);c.registerattribute("winddir",0);c.registerattribute("rainwidth",0.5);c.registerattribute("rainalpha",0.5);c.registerattribute("imagescale",1);c.enabled=!1;c.align="lefttop";c.edge="lefttop";c.width="100%";c.height="100%";c.x=0;c.y=0;c.registercontentsize(256,256);o=document.createElement("canvas");o.width=256;o.height=256;o.style.width="100%";o.style.height="100%";o.onselectstart=function(){return !1};j=o.getContext("2d");c.sprite.appendChild(o);if(p.ismobile||p.istablet){m=15}d=setInterval(b,1000/m);p.set("events["+c.name+"_snowevents].keep",c.keep);p.set("events["+c.name+"_snowevents].onviewchanged",function(){b(null,!0)})};this.unloadplugin=function(){try{clearInterval(d),p.set("events["+c.name+"_snowevents].keep",!1),p.set("events["+c.name+"_snowevents].onviewchanged",null),p.set("events["+c.name+"_snowevents].name",null),c.sprite.removeChild(o),p=c=o=j=d=null}catch(a){}};this.onresize=function(f,a){o&&(o.width=f>>0,o.height=a>>0);return !1}};