var krpanoplugin=function(){function m(a,ag){ag=!0===ag;if(j&&c){var aq=k.get("view");if(null!=aq&&null!=aq.r_rmatrix){var ak=c,ao=j.width,am=j.height;ak.clearRect(0,0,ao,am);var ax,ai=1;switch(String(n.mode).toLowerCase()){case"snow":ai=1;break;case"image":ai=3}var ap=n.flakes;k.ismobile&&1000<ap&&(ap=1000);k.istablet&&2000<ap&&(ap=2000);var al=n.color,aa=1000*n.floor,af=1000*n.spreading,Z=1*n.imagescale,aw=1*n.speed,ae=1*n.shake,ah=1*n.speedvariance,ad=1*n.wind,an=n.winddir*Math.PI/180;d!=al&&(b=null,d=al);if(null==b){b=document.createElement("canvas");b.width=2;b.height=2;var ac=b.getContext("2d");ac.fillStyle="rgba("+(al>>16&255)+","+(al>>8&255)+","+(al&255)+",0.5)";ac.fillRect(0,0,2,2)}var al=b,ac=ad*Math.cos(an),ad=ad*Math.sin(an),an=null,X=0,W=0;if(3==ai){var ar=n.imageurl;if(null==ar||""==ar){return}l!=ar&&(p=null,l=ar,p=new Image,p.src=k.parsePath(l));if(null==p){return}p&&p.complete&&(an=p,X=an.naturalWidth,W=an.naturalHeight);if(null==an){return}}null==i&&(i=Array(3*ap));if(0==ag&&ap!=q){if(q<ap){for(ax=3*q;ax<3*ap;ax+=3){i[0|ax]=(Math.random()-0.5)*af,i[0|ax+2]=(Math.random()-0.5)*af,i[0|ax+1]=-(Math.random()*(aa+1500))+aa}}q=ap}var ao=0.5*ao,ar=0.5*am,M=Number(aq.r_zoff);isNaN(M)&&(M=0);ax=k.stagescale;am=aq.r_zoom*am/k.stageheight/ax;ax=Math.max(4*k.stageheight/3,k.stagewidth)/ax;Z*=ax*am/(2*ar);ax=aq.r_rmatrix;var G,B,v,s,r,h,g,f;ax.hasOwnProperty("m11")?(aq=ax.m11,G=ax.m12,B=ax.m13,v=ax.m21,s=ax.m22,r=ax.m23,h=ax.m31,g=ax.m32,f=ax.m33):(aq=ax[0],G=ax[1],B=ax[2],v=ax[4],s=ax[5],r=ax[6],h=ax[8],g=ax[9],f=ax[10]);var aj=1000/(e+1)/122;0.5<aj&&(aj=0.5);var aj=aj*aw,ae=ae*aj,av,au,at,ab;for(ax=0;ax<3*ap;ax+=3){aw=i[0|ax],av=i[0|ax+1],au=i[0|ax+2],0==ag&&(av+=aj*(10+Math.random()*ah),av>aa&&(aw=(Math.random()-0.5)*af,au=(Math.random()-0.5)*af,av=1*(-1000-500*Math.random())),aw+=(Math.random()-0.5)*ae+ac,au+=(Math.random()-0.5)*ae+ad,2000<aw?aw-=4100:-2000>aw&&(aw+=4100),2000<av?av-=4100:-2000>av&&(av+=4100),i[0|ax]=aw,i[0|ax+1]=av,i[0|ax+2]=au),at=aw,ab=av,aw=aq*at+v*ab+h*au,av=G*at+s*ab+g*au,au=B*at+r*ab+f*au+M,10<au&&(1==ai?(au=am/au,aw*=au,av*=au,aw>-ao&&aw<+ao&&av>-ar&&av<ar&&(aw+=ao-1,av+=ar-1,ak.drawImage(al,aw|0,av|0))):3==ai&&(at=au,au=am/au,aw*=au,av*=au,at=Z/at,au=0.5*X*at,at*=0.5*W,aw>-ao-au&&aw<+ao+au&&av>-ar-at&&av<ar+at&&(aw+=ao-au,av+=ar-at,ak.drawImage(an,0,0,X,W,aw,av,au,at))))}}}}var k=null,n=null,j=null,c=null,d=null,i=null,q=0,l=null,p=null,e=30,o=null,b=null;this.registerplugin=function(f,g,a){k=f;n=a;n.registerattribute("mode","snow");n.registerattribute("imageurl","");n.registerattribute("flakes",k.ismobile||k.istablet?1000:4000);n.registerattribute("color",16777215);n.registerattribute("floor",0.3);n.registerattribute("speed",1);n.registerattribute("spreading",4);n.registerattribute("shake",4);n.registerattribute("speedvariance",2);n.registerattribute("wind",0);n.registerattribute("winddir",0);n.registerattribute("rainwidth",0.5);n.registerattribute("rainalpha",0.5);n.registerattribute("imagescale",1);n.enabled=!1;n.align="lefttop";n.edge="lefttop";n.width="100%";n.height="100%";n.x=0;n.y=0;n.registercontentsize(256,256);j=document.createElement("canvas");j.width=256;j.height=256;j.style.width="100%";j.style.height="100%";j.onselectstart=function(){return !1};c=j.getContext("2d");n.sprite.appendChild(j);if(k.ismobile||k.istablet){e=15}o=setInterval(m,1000/e);k.set("events["+n.name+"_snowevents].keep",n.keep);k.set("events["+n.name+"_snowevents].onviewchanged",function(){m(null,!0)})};this.unloadplugin=function(){try{clearInterval(o),k.set("events["+n.name+"_snowevents].keep",!1),k.set("events["+n.name+"_snowevents].onviewchanged",null),k.set("events["+n.name+"_snowevents].name",null),n.sprite.removeChild(j),k=n=j=c=o=null}catch(a){}};this.onresize=function(g,h){j&&(j.width=g>>0,j.height=h>>0);return !1}};