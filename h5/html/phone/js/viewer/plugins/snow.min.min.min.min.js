var krpanoplugin=function(){function z(K,O){O=!0===O;if(g&&u){var A=f.get("view");if(null!=A&&null!=A.r_rmatrix){var d=u,D=g.width,b=g.height;d.clearRect(0,0,D,b);var j,F=1;switch(String(y.mode).toLowerCase()){case"snow":F=1;break;case"image":F=3}var C=y.flakes;f.ismobile&&1000<C&&(C=1000);f.istablet&&2000<C&&(C=2000);var c=y.color,V=1000*y.floor,P=1000*y.spreading,e=1*y.imagescale,l=1*y.speed,Q=1*y.shake,L=1*y.speedvariance,R=1*y.wind,E=y.winddir*Math.PI/180;s!=c&&(v=null,s=c);if(null==v){v=document.createElement("canvas");v.width=2;v.height=2;var S=v.getContext("2d");S.fillStyle="rgba("+(c>>16&255)+","+(c>>8&255)+","+(c&255)+",0.5)";S.fillRect(0,0,2,2)}var c=v,S=R*Math.cos(E),R=R*Math.sin(E),E=null,i=0,k=0;if(3==F){var q=y.imageurl;if(null==q||""==q){return}a!=q&&(w=null,a=q,w=new Image,w.src=f.parsePath(a));if(null==w){return}w&&w.complete&&(E=w,i=E.naturalWidth,k=E.naturalHeight);if(null==E){return}}null==h&&(h=Array(3*C));if(0==O&&C!=t){if(t<C){for(j=3*t;j<3*C;j+=3){h[0|j]=(Math.random()-0.5)*P,h[0|j+2]=(Math.random()-0.5)*P,h[0|j+1]=-(Math.random()*(V+1500))+V}}t=C}var D=0.5*D,q=0.5*b,I=Number(A.r_zoff);isNaN(I)&&(I=0);j=f.stagescale;b=A.r_zoom*b/f.stageheight/j;j=Math.max(4*f.stageheight/3,f.stagewidth)/j;e*=j*b/(2*q);j=A.r_rmatrix;var N,T,Y,aa,ab,ac,H,J;j.hasOwnProperty("m11")?(A=j.m11,N=j.m12,T=j.m13,Y=j.m21,aa=j.m22,ab=j.m23,ac=j.m31,H=j.m32,J=j.m33):(A=j[0],N=j[1],T=j[2],Y=j[4],aa=j[5],ab=j[6],ac=j[8],H=j[9],J=j[10]);var o=1000/(r+1)/122;0.5<o&&(o=0.5);var o=o*l,Q=Q*o,m,n,p,U;for(j=0;j<3*C;j+=3){l=h[0|j],m=h[0|j+1],n=h[0|j+2],0==O&&(m+=o*(10+Math.random()*L),m>V&&(l=(Math.random()-0.5)*P,n=(Math.random()-0.5)*P,m=1*(-1000-500*Math.random())),l+=(Math.random()-0.5)*Q+S,n+=(Math.random()-0.5)*Q+R,2000<l?l-=4100:-2000>l&&(l+=4100),2000<m?m-=4100:-2000>m&&(m+=4100),h[0|j]=l,h[0|j+1]=m,h[0|j+2]=n),p=l,U=m,l=A*p+Y*U+ac*n,m=N*p+aa*U+H*n,n=T*p+ab*U+J*n+I,10<n&&(1==F?(n=b/n,l*=n,m*=n,l>-D&&l<+D&&m>-q&&m<q&&(l+=D-1,m+=q-1,d.drawImage(c,l|0,m|0))):3==F&&(p=n,n=b/n,l*=n,m*=n,p=e/p,n=0.5*i*p,p*=0.5*k,l>-D-n&&l<+D+n&&m>-q-p&&m<q+p&&(l+=D-n,m+=q-p,d.drawImage(E,0,0,i,k,l,m,n,p))))}}}}var f=null,y=null,g=null,u=null,s=null,h=null,t=0,a=null,w=null,r=30,x=null,v=null;this.registerplugin=function(d,c,b){f=d;y=b;y.registerattribute("mode","snow");y.registerattribute("imageurl","");y.registerattribute("flakes",f.ismobile||f.istablet?1000:4000);y.registerattribute("color",16777215);y.registerattribute("floor",0.3);y.registerattribute("speed",1);y.registerattribute("spreading",4);y.registerattribute("shake",4);y.registerattribute("speedvariance",2);y.registerattribute("wind",0);y.registerattribute("winddir",0);y.registerattribute("rainwidth",0.5);y.registerattribute("rainalpha",0.5);y.registerattribute("imagescale",1);y.enabled=!1;y.align="lefttop";y.edge="lefttop";y.width="100%";y.height="100%";y.x=0;y.y=0;y.registercontentsize(256,256);g=document.createElement("canvas");g.width=256;g.height=256;g.style.width="100%";g.style.height="100%";g.onselectstart=function(){return !1};u=g.getContext("2d");y.sprite.appendChild(g);if(f.ismobile||f.istablet){r=15}x=setInterval(z,1000/r);f.set("events["+y.name+"_snowevents].keep",y.keep);f.set("events["+y.name+"_snowevents].onviewchanged",function(){z(null,!0)})};this.unloadplugin=function(){try{clearInterval(x),f.set("events["+y.name+"_snowevents].keep",!1),f.set("events["+y.name+"_snowevents].onviewchanged",null),f.set("events["+y.name+"_snowevents].name",null),y.sprite.removeChild(g),f=y=g=u=x=null}catch(b){}};this.onresize=function(c,b){g&&(g.width=c>>0,g.height=b>>0);return !1}};