var krpanoplugin=function(){function r(ac,K){K=!0===K;if(u&&y){var n=t.get("view");if(null!=n&&null!=n.r_rmatrix){var E=y,p=u.width,C=u.height;E.clearRect(0,0,p,C);var d,H=1;switch(String(h.mode).toLowerCase()){case"snow":H=1;break;case"image":H=3}var o=h.flakes;t.ismobile&&1000<o&&(o=1000);t.istablet&&2000<o&&(o=2000);var D=h.color,S=1000*h.floor,L=1000*h.spreading,b=1*h.imagescale,i=1*h.speed,N=1*h.shake,I=1*h.speedvariance,O=1*h.wind,q=h.winddir*Math.PI/180;x!=D&&(z=null,x=D);if(null==z){z=document.createElement("canvas");z.width=2;z.height=2;var P=z.getContext("2d");P.fillStyle="rgba("+(D>>16&255)+","+(D>>8&255)+","+(D&255)+",0.5)";P.fillRect(0,0,2,2)}var D=z,P=O*Math.cos(q),O=O*Math.sin(q),q=null,c=0,e=0;if(3==H){var m=h.imageurl;if(null==m||""==m){return}s!=m&&(f=null,s=m,f=new Image,f.src=t.parsePath(s));if(null==f){return}f&&f.complete&&(q=f,c=q.naturalWidth,e=q.naturalHeight);if(null==q){return}}null==v&&(v=Array(3*o));if(0==K&&o!=a){if(a<o){for(d=3*a;d<3*o;d+=3){v[0|d]=(Math.random()-0.5)*L,v[0|d+2]=(Math.random()-0.5)*L,v[0|d+1]=-(Math.random()*(S+1500))+S}}a=o}var p=0.5*p,m=0.5*C,A=Number(n.r_zoff);isNaN(A)&&(A=0);d=t.stagescale;C=n.r_zoom*C/t.stageheight/d;d=Math.max(4*t.stageheight/3,t.stagewidth)/d;b*=d*C/(2*m);d=n.r_rmatrix;var J,Q,T,U,V,Y,aa,ab;d.hasOwnProperty("m11")?(n=d.m11,J=d.m12,Q=d.m13,T=d.m21,U=d.m22,V=d.m23,Y=d.m31,aa=d.m32,ab=d.m33):(n=d[0],J=d[1],Q=d[2],T=d[4],U=d[5],V=d[6],Y=d[8],aa=d[9],ab=d[10]);var F=1000/(w+1)/122;0.5<F&&(F=0.5);var F=F*i,N=N*F,j,k,l,R;for(d=0;d<3*o;d+=3){i=v[0|d],j=v[0|d+1],k=v[0|d+2],0==K&&(j+=F*(10+Math.random()*I),j>S&&(i=(Math.random()-0.5)*L,k=(Math.random()-0.5)*L,j=1*(-1000-500*Math.random())),i+=(Math.random()-0.5)*N+P,k+=(Math.random()-0.5)*N+O,2000<i?i-=4100:-2000>i&&(i+=4100),2000<j?j-=4100:-2000>j&&(j+=4100),v[0|d]=i,v[0|d+1]=j,v[0|d+2]=k),l=i,R=j,i=n*l+T*R+Y*k,j=J*l+U*R+aa*k,k=Q*l+V*R+ab*k+A,10<k&&(1==H?(k=C/k,i*=k,j*=k,i>-p&&i<+p&&j>-m&&j<m&&(i+=p-1,j+=m-1,E.drawImage(D,i|0,j|0))):3==H&&(l=k,k=C/k,i*=k,j*=k,l=b/l,k=0.5*c*l,l*=0.5*e,i>-p-k&&i<+p+k&&j>-m-l&&j<m+l&&(i+=p-k,j+=m-l,E.drawImage(q,0,0,c,e,i,j,k,l))))}}}}var t=null,h=null,u=null,y=null,x=null,v=null,a=0,s=null,f=null,w=30,g=null,z=null;this.registerplugin=function(d,c,b){t=d;h=b;h.registerattribute("mode","snow");h.registerattribute("imageurl","");h.registerattribute("flakes",t.ismobile||t.istablet?1000:4000);h.registerattribute("color",16777215);h.registerattribute("floor",0.3);h.registerattribute("speed",1);h.registerattribute("spreading",4);h.registerattribute("shake",4);h.registerattribute("speedvariance",2);h.registerattribute("wind",0);h.registerattribute("winddir",0);h.registerattribute("rainwidth",0.5);h.registerattribute("rainalpha",0.5);h.registerattribute("imagescale",1);h.enabled=!1;h.align="lefttop";h.edge="lefttop";h.width="100%";h.height="100%";h.x=0;h.y=0;h.registercontentsize(256,256);u=document.createElement("canvas");u.width=256;u.height=256;u.style.width="100%";u.style.height="100%";u.onselectstart=function(){return !1};y=u.getContext("2d");h.sprite.appendChild(u);if(t.ismobile||t.istablet){w=15}g=setInterval(r,1000/w);t.set("events["+h.name+"_snowevents].keep",h.keep);t.set("events["+h.name+"_snowevents].onviewchanged",function(){r(null,!0)})};this.unloadplugin=function(){try{clearInterval(g),t.set("events["+h.name+"_snowevents].keep",!1),t.set("events["+h.name+"_snowevents].onviewchanged",null),t.set("events["+h.name+"_snowevents].name",null),h.sprite.removeChild(u),t=h=u=y=g=null}catch(b){}};this.onresize=function(c,b){u&&(u.width=c>>0,u.height=b>>0);return !1}};