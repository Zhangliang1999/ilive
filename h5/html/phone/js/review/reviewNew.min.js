function init(){checklogin(function(){guide(function(e){var i=e.viewAuthorized;switch(i){case 2:setlogin("password");break;case 3:console.log(3);break;case 6:setlogin("FCode");break;default:$("#loding").hide(),_template.review_page(),myPlayer=videojs("video"),_height=$(window).height()-$(".menuBox").offset().top,createAPI("http://"+tomcatBase+"/ilive/app/room/vod/fileinfo.jspx",{fileId:Params.fileId}).then(function(e){1==e.code?setInit(e):layer.open({content:e.message,btn:"确定",yes:function(){errorfunction()}})},function(e){layerOpen("获取数据失败")})}})})}function checklogin(e){createAPI("http://"+tomcatBase+"/ilive/app/room/vod/checklogin.jspx",{fileId:Params.fileId,roomId:Params.roomId}).then(function(i){if(1==i.code){var t=i.data.roomNeedLogin;if(1===t)setlogin();else{var a=JSON.parse(i.data),n=a.userInfo;null==n&&null==n||(userId=n.userId,$("input[name=userId]").val(n.userId)),e()}}else window.location.href="404.html"})}function guide(e){createAPI("http://"+tomcatBase+"/ilive/app/room/vod/guide.jspx",{fileId:Params.fileId,roomId:Params.roomId}).then(function(i){switch(i.code){case 1:var t=i.data.liveEvent;e(t);break;case 402:setlogin();break;case 404:window.location.href="http://"+h5Base+"/phone/end.html";break;default:layer.open({content:"引导鉴权失败",btn:"确定",yes:function(e){errorfunction()}})}})}function setInit(e){try{if(null!=e.data&&null!=e.data){var i={mediaFileName:e.data.mediaFileName,mediaFileDesc:e.data.mediaFileDesc,filePath:e.data.filePath,viewNum:e.data.viewNum,fileCover:e.data.fileCover,fileCoverImg:e.data.fileCoverImg,allowComment:e.data.allowComment,isFileDoc:e.data.isFileDoc};document.title=i.mediaFileName,$(".liveTitle").html(i.mediaFileName),$(".viewNum").text(setNum(i.viewNum)),setVideo(i),createAPI("http://"+tomcatBase+"/ilive/file/enterprise.jspx",{userId:userId,fileId:Params.fileId}).then(function(e){setEnterprise(e)}),createAPI("http://"+tomcatBase+"/ilive/app/room/getrelatedlist.jspx",{fileId:Params.fileId}).then(function(e){setFileList(e)}),createAPI("http://"+tomcatBase+"/ilive/app/wx/sharefileinfo.jspx",{fileId:Params.fileId}).then(function(e){_shareTitle=e.data.friendCircle.mediaFileName,_shareImg=e.data.friendCircle.shareImg,_shareDesc=e.data.friendCircle.mediaFileDesc,_shareTitle2=e.data.friendSingle.mediaFileName,_shareImg2=e.data.friendSingle.shareImg,_shareDesc2=e.data.friendSingle.mediaFileDesc,options={shareUrl:window.location.href,cover:_shareImg,title:_shareTitle,content:_shareDesc,cover2:_shareImg2,title2:_shareTitle2,content2:_shareDesc2},reviewshareInfo(options)}),1==i.isFileDoc&&(showFileDoc(),$("#wendang").css("display","block")),0==i.allowComment?($(".chatipt").find("span").text("目前还不能讨论哦~"),$("#talkLi").css("display","none"),$(".menuBox").find("li").last().css("display","none")):showcomments(),window.chatipt.onclick=function(){0!=i.allowComment&&chatiptOpen("review")},window.showDesc.onclick=function(){popup({title:"简介",content:desc(i.mediaFileDesc)})}}}catch(e){layerOpen(e)}}function setEnterprise(e){if(1==e.code){var i={enterpriseId:e.data.enterpriseId,enterpriseImg:e.data.enterpriseImg,enterpriseName:e.data.enterpriseName,enterpriseDesc:e.data.enterpriseDesc,concernTotal:e.data.concernTotal,certStatus:e.data.certStatus,concernStatus:e.data.concernStatus,isReg:e.isReg},t=OtherJs_CbCount(i.enterpriseId);ChongQingAdv(i.enterpriseId);var a=t+i.concernTotal;if(concernTotalTemp=a,a=setNum(a),4==i.certStatus){var n={type:1,className:"guanzhu icon-jia"};0!=i.concernStatus&&(n={type:0,className:"yiguanzhu"}),$("#concernStatus").css("display","block").addClass(n.className).attr("onclick","updateConcernStatus("+i.enterpriseId+","+n.type+",event)")}1==i.isReg&&$(".dianzan").find("i").addClass("checked"),createAPI("http://"+tomcatBase+"/ilive/register/MediaRegisterCount.jspx",{fileId:Params.fileId}).then(function(e){if(0==e.code)return layer.open(e.message),!1;$("#dianzan-tag").text(e.data.count)}),$("#companyName").text(i.enterpriseName),$("#concernTotal").find("span").text(setNum(a)),getEnterprise(i.enterpriseId)}else $("#zbjcompany").hide()}function setFileList(e){if(1===e.code&&e.data.length>0){var i=createReviewFile(e.data);$("#reviewsAll").css("display","block").find(".swiper-wrapper").html(i),new Swiper("#reviews",{slidesPerView:2.5,spaceBetween:5}),window.showAllReview.onclick=function(){var i=_template.show_all_review(e.data);$(".review-List").append(i),popup({id:"review",title:"相关视频",content:$("#review").html()})}}}function changeVideo(e){window.location.href="http://"+h5Base+"/phone/review.html?roomId="+Params.roomId+"&fileId="+e}function createReviewFile(e){var i=[];return e.forEach(function(e){var t='<div class="swiper-slide">\n  <div class="review-group" onclick="changeVideo('+e.fileId+')">\n    <div class="review-img">\n      <img src="'+e.fileImg+'" alt="">\n      <div class="reviewMask"><span>'+e.fileDuration+'</span></div>\n    </div>\n    <div class="review-title">'+e.fileName+"</div>\n  </div>\n</div>\n";i.push(t)}),i.join("")}function setVideo(e){var i=e.filePath,t=e.fileCoverImg||"http://pic.zb.tv189.com/img/livebg_default.png";myPlayer.ready(function(){this.src({src:i}),this.poster(t),this.on("error",function(){var e=this.error();console.log(e),1==e.code?layer.alert("视频播放被终止"):2==e.code?layer.alert("网络错误导致视频下载中途失败"):3==e.code?layer.alert("由于视频文件损坏或是该视频使用了你的浏览器不支持的功能，播放终止。"):4==e.code?layer.alert("视频因格式不支持或者服务器或网络的问题无法加载。"):5==e.code&&layer.alert("视频已加密，无法解密。")})})}function showFileDoc(){createAPI("http://"+tomcatBase+"/ilive/document/getByfileId.jspx",{fileId:Params.fileId}).then(function(e){1==e.code&&($("#fileDoc").css("display","block"),createFileDoc(e.data))})}function createFileDoc(e){var i=[];e.forEach(function(e){var t='<dl class="document document_'+e.document.id+'" data-docid="'+e.document.id+'">\n     <dd>\n      <img src="css/review/images/icon-p.png" class="ppt" alt="">\n      <div class="document-name ellipsis" onclick="fileDocDetail('+e.document.id+')">'+e.document.name+'</div>\n      <div class="links"><i class="iconfont icon-youjiantou"></i></div>\n      <div class="fileImgs"></div>\n     </dd>\n</dl>\n';i.push(t)}),fileDoc='<div class="document" style="height: 100vh">'+i.join("")+"</div>",$("#document").html(i.join(""))}function fileDocDetail(e){popupDisable||(popup({id:"document",title:"文档预览",content:fileDoc}),popupDisable=!0);var i=$(".showPopupContent").find(".document_"+e);if(i.hasClass("open"))i.removeClass("open");else{i.addClass("open").siblings().removeClass("open");var t=new MeScroll("mescroll_document",{down:{use:!1},up:{use:!1}});t.scrollTo(i[0].offsetTop-50),null==docArr[e]?createAPI("http://"+tomcatBase+"/ilive/document/getPicByDocId.jspx",{docId:e}).then(function(t){1==t.code&&(docArr[e]=t.data,wendangJS(i,t.data))}):wendangJS(i,docArr[e])}}function wendangJS(e,i){var t='<div class="swiper-container " id="gallery_'+i[0].docId+'">';t+='<div class="swiper-wrapper">\n';for(var a=0;a<i.length;a++){var n=i[a].url;t+='<div class="swiper-slide"><img src="'+n+'"></div>\n'}t+="</div>\n",t+="</div>\n",t+='<div class="swiper-container thumbs" id="thumbs_'+i[0].docId+'">\n',t+=' <div class="swiper-wrapper">\n';for(a=0;a<i.length;a++){n=i[a].url;t+='<div class="swiper-slide"><img src="'+n+'"><span>'+(a+1)+"</span></div>\n"}t+="</div>",e.find(".fileImgs").html(t);var s=new Swiper("#thumbs_"+i[0].docId,{spaceBetween:10,slidesPerView:3,watchSlidesVisibility:!0,watchSlidesProgress:!0,freeMode:!0,freeModeMomentumRatio:5});new Swiper("#gallery_"+i[0].docId,{thumbs:{swiper:s},lazy:{loadPrevNext:!0,loadPrevNextAmount:2}})}function showcomments(){mescroll=new MeScroll("mescroll",{down:{use:!1},up:{auto:!0,isBounce:!1,offset:150,noMoreSize:8,page:{size:10},empty:{warpId:no_comment,icon:"css/review/images/nocomment.png",tip:"还没有讨论，快来聊几句吧~~"},htmlNodata:'<p class="upwarp-nodata">-- 我是有底线的 --</p>',callback:upCallback}}),setTimeout(function(){$(".menuBox").find("li").on("click",function(){if(!$(this).hasClass("liactive")){if("talkLi"==this.className){var e=document.querySelectorAll(".talkLi")[1],i=e.offsetTop+1;return $(e).css("min-height",_height),void mescroll.scrollTo(i)}mescroll.scrollTo(0)}}),$(".mescroll").scroll(function(){nScrollTop=$(this)[0].scrollTop;var e=document.querySelectorAll(".talkLi")[1],i=e.offsetTop;$(".menuBox").find("li.zbjj").addClass("liactive").siblings().removeClass("liactive"),nScrollTop>i&&$(".menuBox").find("li.talkLi").addClass("liactive").siblings().removeClass("liactive")})},0)}function upCallback(e){getListDataFromNet(e.num,e.size,function(e){mescroll.endSuccess(e.length),setListData(e)},function(){mescroll.endErr()})}function getListDataFromNet(e,i,t,a){setTimeout(function(){try{createAPI("http://"+tomcatBase+"/ilive/app/room/vod/getcomments.jspx",{fileId:Params.fileId,pageNo:e,pageSize:i}).then(function(e){t&&t(e.data)})}catch(e){a&&a()}},1e3)}function setListData(e){var i=[],t="";e.forEach(function(e){t=commentDom(e),i.push(t)}),$("#comment").append(i.join(""))}function commentDom(e){var i={className:"",css:""};return 1==e.topFlagNum&&(i.className=" topBox",i.css=' style="display: inline-block"'),str='<div class="talkline'+i.className+'" id="'+e.commentsId+'">\n          <div class="userImg"><img src="'+e.userImg+'"></div>\n          <div class="commentText">\n               <div class="inlineName">\n                   <span class="senderName">'+e.commentsUser+'<i class="questionIcon stickIcon" '+i.css+'></i></span>\n                   <span class="createTime">'+e.createTime+'</span>\n               </div>\n             <div class="comment">'+e.comments+"</div>\n           </div>      </div>"}function saveMediaFile(){createAPI("http://"+tomcatBase+"/ilive/register/registerMedia.jspx",{fileId:Params.fileId,userId:userId}).then(function(e){$(".dianzan").find("i").addClass("checked");var i=$("#dianzan-tag"),t=i.text();i.text(++t)})}function desc(e){var i=$(".liveTitle").html(),t=$(".play-num").html();return'<div class="desc-content">\n       <div class="title liveTitle">'+i+'</div>\n       <div class="play-num">'+t+'</div>\n  <div class="content">'+e+"</div>\n"}function talkCon(){return'<div id="talkCon">\n    <div class="talkCon box">\n        <input type="text"  class="textarea"  placeholder="聊几句吧" id="saytext" onblur="wchatHackInput()" name="msgContent">\n        <div class="talkBottom">\n            <div class="hiddenDiv" style="display: none;"></div>\n            <div class="newhiddenDiv" style="display: none;"></div>\n            <div class="biaoqing emotion" data="emoji"></div>\n            <button class="sendMessage" disabled onclick="saveComments()">发送</button>\n            <div class="emojiBox" style="display: none;">\n                <section class="emoji_container"></section>\n            </div>\n        </div>\n    </div>\n</div>'}/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)||(window.location.href="http://"+h5Base+"/pc/review.html?fileId="+Params.fileId+"&roomId="+Params.roomId),""==Params.fileId?errorfunction():judgeDeviceType.isWeiXin?createAPI("http://"+tomcatBase+"/ilive/app/wx/app.jspx",{fileId:Params.fileId,roomId:Params.roomId}).then(function(e){var i=e.loginWx;if(1==i)return window.stop(),window.location.href=e.loginUrl,!1}).then(function(){init()}):init();var mescroll,fileDoc=null,popupDisable=!1,docArr=[];